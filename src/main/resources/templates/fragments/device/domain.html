<div th:fragment="content" class="page-body">
    <div class="container-xl">
        <div class="card" id="domains-app" @vue:mounted="mounted">
            <div class="card-header">
                <h3 class="card-title">域名管理</h3>
                <div class="card-actions">
                    <div class="row g-2">
                        <div class="col">
                            <input type="text" class="form-control" placeholder="搜索..." v-model="searchQuery" @input="searchDebounced">
                        </div>
                        <div class="col-auto">
                            <div class="input-group">
                                <span class="input-group-text">到期从</span>
                                <input type="date" class="form-control" v-model="expiryFrom" @change="fetchDomains">
                            </div>
                        </div>
                        <div class="col-auto">
                            <div class="input-group">
                                <span class="input-group-text">到期至</span>
                                <input type="date" class="form-control" v-model="expiryTo" @change="fetchDomains">
                            </div>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-primary" @click="openCreateDomainModal">
                                <i class="ti ti-plus"></i> 添加域名
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 域名统计卡片 -->
            <div class="card-body border-bottom">
                <div class="row">
                    <div class="col-sm-6 col-lg-3">
                        <div class="card card-sm">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <span class="bg-primary text-white avatar">
                                            <i class="ti ti-world"></i>
                                        </span>
                                    </div>
                                    <div class="col">
                                        <div class="font-weight-medium">
                                            域名总数
                                        </div>
                                        <div class="text-muted">
                                            {{ totalItems }} 个域名
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-3">
                        <div class="card card-sm">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <span class="bg-red text-white avatar">
                                            <i class="ti ti-alert-triangle"></i>
                                        </span>
                                    </div>
                                    <div class="col">
                                        <div class="font-weight-medium">
                                            已过期
                                        </div>
                                        <div class="text-muted">
                                            {{ expiredCount }} 个域名
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-3">
                        <div class="card card-sm">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <span class="bg-yellow text-white avatar">
                                            <i class="ti ti-clock"></i>
                                        </span>
                                    </div>
                                    <div class="col">
                                        <div class="font-weight-medium">
                                            即将到期
                                        </div>
                                        <div class="text-muted">
                                            {{ expiringCount }} 个域名 (30天内)
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-3">
                        <div class="card card-sm">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <span class="bg-blue text-white avatar">
                                            <i class="ti ti-coin"></i>
                                        </span>
                                    </div>
                                    <div class="col">
                                        <div class="font-weight-medium">
                                            总成本
                                        </div>
                                        <div class="text-muted">
                                            ¥ {{ totalCost.toFixed(2) }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-vcenter card-table">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>域名</th>
                            <th>到期日</th>
                            <th>状态</th>
                            <th>价格</th>
                            <th>备注</th>
                            <th>操作</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr v-for="domain in domains" :key="domain.id">
                            <td v-text="domain.id"></td>
                            <td>
                                <a :href="'http://' + domain.domain" target="_blank" class="text-reset">{{ domain.domain }}</a>
                            </td>
                            <td v-text="formatDate(domain.expireDate)"></td>
                            <td>
                                <span class="badge" :class="getStatusBadgeClass(domain.daysUntilExpiration)">
                                    {{ getDomainStatus(domain.daysUntilExpiration) }}
                                </span>
                            </td>
                            <td>¥ {{ domain.price ? domain.price.toFixed(2) : '-' }}</td>
                            <td v-text="domain.remark || '-'"></td>
                            <td>
                                <div class="btn-list flex-nowrap">
                                    <button @click="openEditDomainModal(domain)" class="btn btn-sm btn-outline-primary">
                                        <i class="ti ti-edit"></i> 编辑
                                    </button>
                                    <button @click="confirmDelete(domain)" class="btn btn-sm btn-outline-danger">
                                        <i class="ti ti-trash"></i> 删除
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <tr v-if="loading">
                            <td colspan="7" class="text-center py-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </td>
                        </tr>
                        <tr v-else-if="domains.length === 0">
                            <td colspan="7" class="text-center py-3">没有查到数据.</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- 分页 -->
            <div class="card-footer d-flex align-items-center">
                <div class="d-flex">
                    <div class="text-muted">
                        每页显示
                        <div class="mx-2 d-inline-block">
                            <select class="form-select form-select-sm" v-model="pageSize" @change="changePageSize">
                                <option value="5">5</option>
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                        条记录
                    </div>
                    <div class="ms-auto text-muted" v-if="totalItems > 0">
                        显示
                        <span class="text-body strong">{{ startIndex }}</span> 到
                        <span class="text-body strong">{{ endIndex }}</span> 条，共
                        <span class="text-body strong">{{ totalItems }}</span> 条
                    </div>
                </div>
                <ul class="pagination m-0 ms-auto" v-if="totalPages > 0">
                    <li class="page-item" :class="{ disabled: currentPage === 1 }">
                        <a class="page-link" href="#" @click.prevent="prevPage">
                            <i class="ti ti-chevron-left"></i> 上一页
                        </a>
                    </li>
                    <!-- Display page numbers dynamically -->
                    <li class="page-item" v-for="page in paginationPages" :key="page"
                        :class="{ active: page === currentPage }">
                        <a class="page-link" href="#" @click.prevent="goToPage(page)">{{ page }}</a>
                    </li>
                    <li class="page-item" :class="{ disabled: currentPage === totalPages }">
                        <a class="page-link" href="#" @click.prevent="nextPage">
                            下一页 <i class="ti ti-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Delete Confirmation Modal -->
            <div class="modal modal-blur fade" id="deleteModal" tabindex="-1" role="dialog">
                <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-body">
                            <div class="modal-title">确定删除吗?</div>
                            <div>若确认删除，数据将无法恢复</div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-link link-secondary me-auto" data-bs-dismiss="modal">取消</button>
                            <button type="button" class="btn btn-danger" @click="deleteDomain">确认</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Create Domain Modal -->
            <div class="modal modal-blur fade" id="createDomainModal" tabindex="-1" role="dialog">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">添加域名</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label required">域名</label>
                                <input type="text" class="form-control" :class="{ 'is-invalid': validationErrors.domain }" placeholder="example.com" v-model="newDomain.domain">
                                <div class="invalid-feedback" v-if="validationErrors.domain">{{ validationErrors.domain }}</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">到期日期</label>
                                <input type="date" class="form-control" :class="{ 'is-invalid': validationErrors.expireDate }" v-model="newDomain.expireDate">
                                <div class="invalid-feedback" v-if="validationErrors.expireDate">{{ validationErrors.expireDate }}</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">价格</label>
                                <div class="input-group">
                                    <span class="input-group-text">¥</span>
                                    <input type="number" class="form-control" step="0.01" min="0" v-model="newDomain.price">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">备注</label>
                                <textarea class="form-control" rows="3" v-model="newDomain.remark"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-link link-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="button" class="btn btn-primary" @click="createDomain">创建</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit Domain Modal -->
            <div class="modal modal-blur fade" id="editDomainModal" tabindex="-1" role="dialog">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">编辑域名</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label required">域名</label>
                                <input type="text" class="form-control" :class="{ 'is-invalid': validationErrors.domain }" placeholder="example.com" v-model="editedDomain.domain">
                                <div class="invalid-feedback" v-if="validationErrors.domain">{{ validationErrors.domain }}</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">到期日期</label>
                                <input type="date" class="form-control" :class="{ 'is-invalid': validationErrors.expireDate }" v-model="editedDomain.expireDate">
                                <div class="invalid-feedback" v-if="validationErrors.expireDate">{{ validationErrors.expireDate }}</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">价格</label>
                                <div class="input-group">
                                    <span class="input-group-text">¥</span>
                                    <input type="number" class="form-control" step="0.01" min="0" v-model="editedDomain.price">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">备注</label>
                                <textarea class="form-control" rows="3" v-model="editedDomain.remark"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-link link-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="button" class="btn btn-primary" @click="updateDomain">保存</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:fragment="script" th:inline="javascript">
    PetiteVue.createApp({
        // Data
        domains: [],
        searchQuery: '',
        expiryFrom: '',
        expiryTo: '',
        currentPage: 1,
        pageSize: 10,
        totalItems: 0,
        totalPages: 0,
        expiredCount: 0,
        expiringCount: 0,
        totalCost: 0,
        selectedDomain: null,
        deleteModal: null,
        createModal: null,
        editModal: null,
        loading: true,
        searchTimeout: null,
        newDomain: {
            domain: '',
            expireDate: '',
            price: '',
            remark: ''
        },
        editedDomain: {
            id: null,
            domain: '',
            expireDate: '',
            price: '',
            remark: ''
        },
        validationErrors: {},

        // Lifecycle hooks
        mounted() {
            this.fetchDomains();
        },

        // Computed properties
        get startIndex() {
            return (this.currentPage - 1) * this.pageSize + 1;
        },

        get endIndex() {
            return Math.min(this.startIndex + this.pageSize - 1, this.totalItems);
        },

        get paginationPages() {
            // Show at most 5 page numbers
            const maxPages = 5;
            const pages = [];
            let startPage = Math.max(1, this.currentPage - Math.floor(maxPages / 2));
            let endPage = Math.min(this.totalPages, startPage + maxPages - 1);

            if (endPage - startPage + 1 < maxPages) {
                startPage = Math.max(1, endPage - maxPages + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                pages.push(i);
            }

            return pages;
        },

        // Methods
        fetchDomains() {
            this.loading = true;

            // Build query parameters
            const params = new URLSearchParams({
                page: this.currentPage,
                size: this.pageSize
            });

            if (this.searchQuery) {
                params.append('search', this.searchQuery);
            }

            if (this.expiryFrom) {
                params.append('expiryFrom', this.expiryFrom);
            }

            if (this.expiryTo) {
                params.append('expiryTo', this.expiryTo);
            }

            fetch(`/api/admin/domains?${params.toString()}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    this.domains = data.records;
                    this.totalItems = data.total;
                    this.totalPages = data.pages;
                    this.currentPage = data.current;

                    // 统计数据
                    this.expiredCount = data.expiredCount || 0;
                    this.expiringCount = data.expiringCount || 0;
                    this.totalCost = data.totalCost || 0;

                    this.loading = false;
                })
                .catch(error => {
                    console.error('Error fetching domains:', error);
                    ToastUtils.show('Error', 'Failed to load domains.', 'danger');
                    this.loading = false;
                });
        },

        searchDebounced() {
            // Clear existing timeout
            if (this.searchTimeout) {
                clearTimeout(this.searchTimeout);
            }

            // Set new timeout to delay the API call
            this.searchTimeout = setTimeout(() => {
                this.currentPage = 1; // Reset to first page when searching
                this.fetchDomains();
            }, 500); // Wait for 500ms after user stops typing
        },

        formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString();
        },

        getDomainStatus(daysUntilExpiration) {
            if (daysUntilExpiration === undefined || daysUntilExpiration === null) {
                return "未设置到期日";
            }

            if (daysUntilExpiration < 0) {
                return "已过期 " + Math.abs(daysUntilExpiration) + " 天";
            } else if (daysUntilExpiration === 0) {
                return "今天到期";
            } else if (daysUntilExpiration <= 30) {
                return "即将到期 " + daysUntilExpiration + " 天";
            } else {
                return "正常 (还有 " + daysUntilExpiration + " 天)";
            }
        },

        getStatusBadgeClass(daysUntilExpiration) {
            if (daysUntilExpiration === undefined || daysUntilExpiration === null) {
                return "text-bg-secondary";
            }

            if (daysUntilExpiration < 0) {
                return "text-bg-danger";
            } else if (daysUntilExpiration <= 30) {
                return "text-bg-warning";
            } else {
                return "text-bg-success";
            }
        },

        prevPage() {
            if (this.currentPage > 1) {
                this.currentPage--;
                this.fetchDomains();
            }
        },

        nextPage() {
            if (this.currentPage < this.totalPages) {
                this.currentPage++;
                this.fetchDomains();
            }
        },

        goToPage(page) {
            this.currentPage = page;
            this.fetchDomains();
        },

        changePageSize() {
            this.currentPage = 1; // Reset to first page when changing page size
            this.fetchDomains();
        },

        confirmDelete(domain) {
            this.selectedDomain = domain;
            this.deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            this.deleteModal.show();
        },

        deleteDomain() {
            if (!this.selectedDomain) return;

            fetch(`/api/admin/domains/${this.selectedDomain.id}`, {
                method: 'DELETE'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('删除失败');
                    }

                    // Refetch the domains data to update the list and pagination
                    this.fetchDomains();
                    ToastUtils.show('Success', '删除成功', 'success');

                    // Hide modal
                    this.deleteModal.hide();
                })
                .catch(error => {
                    console.error('Error:', error);
                    ToastUtils.show('Error', '删除失败', 'danger');
                });
        },

        // Create Domain methods
        openCreateDomainModal() {
            // Get today's date for default expiration date (1 year from now)
            const today = new Date();
            today.setFullYear(today.getFullYear() + 1); // Add one year
            const oneYearFromNow = today.toISOString().split('T')[0];

            // Reset form
            this.newDomain = {
                domain: '',
                expireDate: oneYearFromNow,
                price: '',
                remark: ''
            };
            this.validationErrors = {};

            // Show modal
            this.createModal = new bootstrap.Modal(document.getElementById('createDomainModal'));
            this.createModal.show();
        },

        validateDomainForm(domain) {
            let isValid = true;
            this.validationErrors = {};

            // Domain validation
            if (!domain.domain || !domain.domain.trim()) {
                this.validationErrors.domain = '域名不能为空';
                isValid = false;
            } else if (!/^[a-zA-Z0-9][a-zA-Z0-9-]{1,61}[a-zA-Z0-9](?:\.[a-zA-Z]{2,})+$/.test(domain.domain)) {
                this.validationErrors.domain = '请输入有效的域名';
                isValid = false;
            }

            return isValid;
        },

        createDomain() {
            if (!this.validateDomainForm(this.newDomain)) {
                return;
            }

            // Prepare data for API
            const domainData = {
                domain: this.newDomain.domain,
                expireDate: this.newDomain.expireDate || null,
                price: this.newDomain.price || null,
                remark: this.newDomain.remark || null
            };

            fetch('/api/admin/domains', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(domainData)
            })
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 400) {
                            return response.json().then(data => {
                                throw new Error(data.message || 'Validation error');
                            });
                        }
                        throw new Error('响应失败');
                    }
                    return response.json();
                })
                .then(data => {
                    this.fetchDomains(); // Refresh the domain list
                    this.createModal.hide();
                    ToastUtils.show('Success', '创建成功', 'success');
                })
                .catch(error => {
                    console.error('Error:', error);
                    ToastUtils.show('Error', error.message || '创建失败.', 'danger');
                });
        },

        // Edit Domain methods
        openEditDomainModal(domain) {
            // Format date for date input
            const formatDateForInput = (dateString) => {
                if (!dateString) return '';
                const date = new Date(dateString);
                return date.toISOString().split('T')[0]; // Format: YYYY-MM-DD
            };

            // Clone domain data to avoid direct mutation
            this.editedDomain = {
                id: domain.id,
                domain: domain.domain,
                expireDate: formatDateForInput(domain.expireDate),
                price: domain.price,
                remark: domain.remark || ''
            };
            this.validationErrors = {};

            // Show modal
            this.editModal = new bootstrap.Modal(document.getElementById('editDomainModal'));
            this.editModal.show();
        },

        updateDomain() {
            if (!this.validateDomainForm(this.editedDomain)) {
                return;
            }

            // Prepare data for API
            const domainData = {
                domain: this.editedDomain.domain,
                expireDate: this.editedDomain.expireDate || null,
                price: this.editedDomain.price || null,
                remark: this.editedDomain.remark || null
            };

            fetch(`/api/admin/domains/${this.editedDomain.id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(domainData)
            })
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 400) {
                            return response.json().then(data => {
                                throw new Error(data.message || 'Validation error');
                            });
                        }
                        throw new Error('响应失败');
                    }
                    return response.json();
                })
                .then(data => {
                    // Refresh the domain list to get updated data including expiry status
                    this.fetchDomains();

                    this.editModal.hide();
                    ToastUtils.show('Success', '更新成功', 'success');
                })
                .catch(error => {
                    console.error('Error:', error);
                    ToastUtils.show('Error', error.message || '更新失败', 'danger');
                });
        },
    }).mount('#domains-app');
</script>