<div th:fragment="content" class="page-body">
    <div class="container-xl">
        <div class="card" id="transactions-app" @vue:mounted="mounted">
            <div class="card-header">
                <h3 class="card-title">交易流水</h3>
                <div class="card-actions">
                    <div class="row g-2">
                        <div class="col">
                            <input type="text" class="form-control" placeholder="搜索描述、备注..." v-model="searchQuery" @input="searchDebounced">
                        </div>
                        <div class="col-auto">
                            <select class="form-select" v-model="filterType" @change="fetchTransactions">
                                <option value="">全部类型</option>
                                <option v-for="type in transactionTypes" :key="type.value" :value="type.value">{{ type.label }}</option>
                            </select>
                        </div>
                        <div class="col-auto">
                            <select class="form-select" v-model="filterBusinessTable" @change="fetchTransactions">
                                <option value="">全部业务</option>
                                <option v-for="table in businessTables" :key="table.value" :value="table.value">{{ table.label }}</option>
                            </select>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-primary" @click="openCreateTransactionModal">
                                <i class="ti ti-plus"></i> 添加交易
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 交易统计卡片 -->
            <div class="card-body border-bottom">
                <div class="row">
                    <div class="col-sm-6 col-lg-3">
                        <div class="card card-sm">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <span class="bg-primary text-white avatar">
                                            <i class="ti ti-exchange"></i>
                                        </span>
                                    </div>
                                    <div class="col">
                                        <div class="font-weight-medium">
                                            总交易金额
                                        </div>
                                        <div class="text-muted">
                                            ¥ {{ formatCurrency(parseFloat(stats.totalIncome) + parseFloat(stats.totalExpense)) }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-3">
                        <div class="card card-sm">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <span class="bg-green text-white avatar">
                                            <i class="ti ti-arrow-up"></i>
                                        </span>
                                    </div>
                                    <div class="col">
                                        <div class="font-weight-medium">
                                            总收入
                                        </div>
                                        <div class="text-muted">
                                            ¥ {{ formatCurrency(stats.totalIncome) }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-3">
                        <div class="card card-sm">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <span class="bg-red text-white avatar">
                                            <i class="ti ti-arrow-down"></i>
                                        </span>
                                    </div>
                                    <div class="col">
                                        <div class="font-weight-medium">
                                            总支出
                                        </div>
                                        <div class="text-muted">
                                            ¥ {{ formatCurrency(stats.totalExpense) }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-3">
                        <div class="card card-sm">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <span class="bg-yellow text-white avatar">
                                            <i class="ti ti-wallet"></i>
                                        </span>
                                    </div>
                                    <div class="col">
                                        <div class="font-weight-medium">
                                            净收入
                                        </div>
                                        <div class="text-muted" :class="parseFloat(stats.netBalance) >= 0 ? 'text-success' : 'text-danger'">
                                            ¥ {{ formatCurrency(stats.netBalance) }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 收支趋势图 -->
            <div class="card-body border-bottom">
                <h3 class="card-title">收支趋势</h3>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="trends-chart" style="width: 100%; height: 100%"></canvas>
                </div>
            </div>

            <div class="card-body p-0">
                <table class="table table-vcenter card-table">
                    <thead>
                    <tr>
                        <th style="width: 10%">日期</th>
                        <th style="width: 15%">金额</th>
                        <th style="width: 10%">类型</th>
                        <th style="width: 15%">关联业务</th>
                        <th style="width: 20%">描述</th>
                        <th style="width: 15%">支付方式</th>
                        <th style="width: 15%">操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr v-for="transaction in transactions" :key="transaction.id">
                        <td>{{ formatDateTime(transaction.transactionDate) }}</td>
                        <td>
                            <span :class="transaction.type == 0 ? 'text-success' : 'text-danger'">
                                {{ transaction.type == 0 ? '+' : '-' }} ¥ {{ formatCurrency(transaction.amount) }}
                            </span>
                        </td>
                        <td>
                            <span class="badge" :class="getTypeBadgeClass(transaction.type)">
                                {{ transaction.typeDescription }}
                            </span>
                        </td>
                        <td>
                            <div v-if="transaction.businessTable">
                                {{ getBusinessTableLabel(transaction.businessTable) }}:
                                <span class="text-muted">{{ transaction.businessName }}</span>
                            </div>
                            <span v-else>-</span>
                        </td>
                        <td>
                            <div class="d-flex flex-column">
                                <span v-text="transaction.description || '-'"></span>
                                <span v-if="transaction.remark" class="text-muted small">{{ transaction.remark }}</span>
                            </div>
                        </td>
                        <td v-text="transaction.paymentMethod || '-'"></td>
                        <td>
                            <div class="btn-list flex-nowrap">
                                <div class="dropdown">
                                    <button class="btn btn-sm dropdown-toggle align-text-top" data-bs-toggle="dropdown">
                                        操作
                                    </button>
                                    <div class="dropdown-menu dropdown-menu-end">
                                        <a class="dropdown-item" href="#" @click.prevent="openEditTransactionModal(transaction)">
                                            <i class="ti ti-edit"></i> 编辑
                                        </a>
                                        <div class="dropdown-divider"></div>
                                        <a class="dropdown-item text-danger" href="#" @click.prevent="confirmDelete(transaction)">
                                            <i class="ti ti-trash"></i> 删除
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr v-if="loading">
                        <td colspan="7" class="text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </td>
                    </tr>
                    <tr v-else-if="transactions.length === 0">
                        <td colspan="7" class="text-center py-3">没有查到数据.</td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <!-- 分页 -->
            <div class="card-footer d-flex align-items-center">
                <div class="d-flex">
                    <div class="text-muted">
                        每页显示
                        <div class="mx-2 d-inline-block">
                            <select class="form-select form-select-sm" v-model="pageSize" @change="changePageSize">
                                <option value="5">5</option>
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                        条记录
                    </div>
                    <div class="ms-auto text-muted" v-if="totalItems > 0">
                        显示
                        <span class="text-body strong">{{ startIndex }}</span> 到
                        <span class="text-body strong">{{ endIndex }}</span> 条，共
                        <span class="text-body strong">{{ totalItems }}</span> 条
                    </div>
                </div>
                <ul class="pagination m-0 ms-auto" v-if="totalPages > 0">
                    <li class="page-item" :class="{ disabled: currentPage === 1 }">
                        <a class="page-link" href="#" @click.prevent="prevPage">
                            <i class="ti ti-chevron-left"></i> 上一页
                        </a>
                    </li>
                    <!-- Display page numbers dynamically -->
                    <li class="page-item" v-for="page in paginationPages" :key="page"
                        :class="{ active: page === currentPage }">
                        <a class="page-link" href="#" @click.prevent="goToPage(page)">{{ page }}</a>
                    </li>
                    <li class="page-item" :class="{ disabled: currentPage === totalPages }">
                        <a class="page-link" href="#" @click.prevent="nextPage">
                            下一页 <i class="ti ti-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Delete Confirmation Modal -->
            <div class="modal modal-blur fade" id="deleteModal" tabindex="-1" role="dialog">
                <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-body">
                            <div class="modal-title">确定删除吗?</div>
                            <div>若确认删除，数据将无法恢复</div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-link link-secondary me-auto" data-bs-dismiss="modal">取消</button>
                            <button type="button" class="btn btn-danger" @click="deleteTransaction">确认</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Create Transaction Modal -->
            <div class="modal modal-blur fade" id="createTransactionModal" tabindex="-1" role="dialog">
                <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">添加交易</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label required">交易日期</label>
                                        <input type="datetime-local" class="form-control" :class="{ 'is-invalid': validationErrors.transactionDate }" v-model="newTransaction.transactionDate">
                                        <div class="invalid-feedback" v-if="validationErrors.transactionDate">{{ validationErrors.transactionDate }}</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label required">交易类型</label>
                                        <select class="form-select" :class="{ 'is-invalid': validationErrors.type }" v-model="newTransaction.type">
                                            <option v-for="type in transactionTypes" :key="type.value" :value="parseInt(type.value)">{{ type.label }}</option>
                                        </select>
                                        <div class="invalid-feedback" v-if="validationErrors.type">{{ validationErrors.type }}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label required">金额</label>
                                        <div class="input-group">
                                            <span class="input-group-text">¥</span>
                                            <input type="number" step="0.01" min="0" class="form-control" :class="{ 'is-invalid': validationErrors.amount }" v-model="newTransaction.amount">
                                        </div>
                                        <div class="invalid-feedback" v-if="validationErrors.amount">{{ validationErrors.amount }}</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">支付方式</label>
                                        <input type="text" class="form-control" v-model="newTransaction.paymentMethod" placeholder="如：支付宝、微信、银行卡">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">关联业务类型</label>
                                        <select class="form-select" v-model="newTransaction.businessTable" @change="onBusinessTableChange">
                                            <option value="">无关联业务</option>
                                            <option v-for="table in businessTables" :key="table.value" :value="table.value">{{ table.label }}</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">关联业务</label>
                                        <select class="form-select" v-model="newTransaction.businessId" :disabled="!newTransaction.businessTable">
                                            <option value="">请选择</option>
                                            <option v-for="business in businessItems" :key="business.id" :value="business.id">{{ business.name }}</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label required">描述</label>
                                <input type="text" class="form-control" :class="{ 'is-invalid': validationErrors.description }" v-model="newTransaction.description">
                                <div class="invalid-feedback" v-if="validationErrors.description">{{ validationErrors.description }}</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">备注</label>
                                <textarea class="form-control" v-model="newTransaction.remark" rows="2"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-link link-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="button" class="btn btn-primary" @click="createTransaction">创建</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit Transaction Modal -->
            <div class="modal modal-blur fade" id="editTransactionModal" tabindex="-1" role="dialog">
                <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">编辑交易</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label required">交易日期</label>
                                        <input type="datetime-local" class="form-control" :class="{ 'is-invalid': validationErrors.transactionDate }" v-model="editedTransaction.transactionDate">
                                        <div class="invalid-feedback" v-if="validationErrors.transactionDate">{{ validationErrors.transactionDate }}</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label required">交易类型</label>
                                        <select class="form-select" :class="{ 'is-invalid': validationErrors.type }" v-model="editedTransaction.type">
                                            <option v-for="type in transactionTypes" :key="type.value" :value="parseInt(type.value)">{{ type.label }}</option>
                                        </select>
                                        <div class="invalid-feedback" v-if="validationErrors.type">{{ validationErrors.type }}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label required">金额</label>
                                        <div class="input-group">
                                            <span class="input-group-text">¥</span>
                                            <input type="number" step="0.01" min="0" class="form-control" :class="{ 'is-invalid': validationErrors.amount }" v-model="editedTransaction.amount">
                                        </div>
                                        <div class="invalid-feedback" v-if="validationErrors.amount">{{ validationErrors.amount }}</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">支付方式</label>
                                        <input type="text" class="form-control" v-model="editedTransaction.paymentMethod" placeholder="如：支付宝、微信、银行卡">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">关联业务类型</label>
                                        <select class="form-select" v-model="editedTransaction.businessTable" @change="onEditBusinessTableChange">
                                            <option value="">无关联业务</option>
                                            <option v-for="table in businessTables" :key="table.value" :value="table.value">{{ table.label }}</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">关联业务</label>
                                        <select class="form-select" v-model="editedTransaction.businessId" :disabled="!editedTransaction.businessTable">
                                            <option value="">请选择</option>
                                            <option v-for="business in businessItems" :key="business.id" :value="business.id">{{ business.name }}</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label required">描述</label>
                                <input type="text" class="form-control" :class="{ 'is-invalid': validationErrors.description }" v-model="editedTransaction.description">
                                <div class="invalid-feedback" v-if="validationErrors.description">{{ validationErrors.description }}</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">备注</label>
                                <textarea class="form-control" v-model="editedTransaction.remark" rows="2"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-link link-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="button" class="btn btn-primary" @click="updateTransaction">保存</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:fragment="script" th:inline="javascript">
    PetiteVue.createApp({
        // Data
        transactions: [],
        transactionTypes: [],
        businessTables: [],
        businessItems: [],
        trendsChart: null,
        searchQuery: '',
        filterType: '',
        filterBusinessTable: '',
        currentPage: 1,
        pageSize: 10,
        totalItems: 0,
        totalPages: 0,
        stats: {
            totalIncome: 0,
            totalExpense: 0,
            netBalance: 0,
            currentMonthIncome: 0,
            currentMonthExpense: 0
        },
        monthlyStats: [],
        selectedTransaction: null,
        deleteModal: null,
        createModal: null,
        editModal: null,
        loading: true,
        searchTimeout: null,
        newTransaction: {
            transactionDate: '',
            amount: '',
            type: 0, // Default to income
            businessTable: '',
            businessId: '',
            description: '',
            paymentMethod: '',
            remark: ''
        },
        editedTransaction: {
            id: null,
            transactionDate: '',
            amount: '',
            type: 0,
            businessTable: '',
            businessId: '',
            description: '',
            paymentMethod: '',
            remark: ''
        },
        validationErrors: {},

        // Lifecycle hooks
        mounted() {
            this.fetchTransactionTypes();
            this.fetchBusinessTables();
            this.fetchMonthlyStats();
            this.fetchTransactions();
        },

        // Computed properties
        get startIndex() {
            return (this.currentPage - 1) * this.pageSize + 1;
        },

        get endIndex() {
            return Math.min(this.startIndex + this.pageSize - 1, this.totalItems);
        },

        get paginationPages() {
            // Show at most 5 page numbers
            const maxPages = 5;
            const pages = [];
            let startPage = Math.max(1, this.currentPage - Math.floor(maxPages / 2));
            let endPage = Math.min(this.totalPages, startPage + maxPages - 1);

            if (endPage - startPage + 1 < maxPages) {
                startPage = Math.max(1, endPage - maxPages + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                pages.push(i);
            }

            return pages;
        },

        // Methods
        fetchTransactions() {
            this.loading = true;

            // Build query parameters
            const params = new URLSearchParams({
                page: this.currentPage,
                size: this.pageSize
            });

            if (this.searchQuery) {
                params.append('search', this.searchQuery);
            }

            if (this.filterType !== '') {
                params.append('type', this.filterType);
            }

            if (this.filterBusinessTable !== '') {
                params.append('businessTable', this.filterBusinessTable);
            }

            fetch(`/api/admin/transactions?${params.toString()}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    this.transactions = data.records;
                    this.totalItems = data.total;
                    this.totalPages = data.pages;
                    this.currentPage = data.current;

                    // 统计数据
                    if (data.stats) {
                        this.stats = data.stats;
                    }

                    this.loading = false;
                })
                .catch(error => {
                    console.error('Error fetching transactions:', error);
                    ToastUtils.show('Error', 'Failed to load transactions.', 'danger');
                    this.loading = false;
                });
        },

        fetchTransactionTypes() {
            fetch('/api/admin/transactions/types')
                .then(response => response.json())
                .then(data => {
                    this.transactionTypes = data;
                })
                .catch(error => {
                    console.error('Error fetching transaction types:', error);
                });
        },

        fetchBusinessTables() {
            fetch('/api/admin/transactions/business-tables')
                .then(response => response.json())
                .then(data => {
                    this.businessTables = data;
                })
                .catch(error => {
                    console.error('Error fetching business tables:', error);
                });
        },

        fetchBusinessItems(table) {
            if (!table) {
                this.businessItems = [];
                return;
            }

            let url = '';
            switch (table) {
                case 'account':
                    url = '/api/admin/accounts';
                    break;
                case 'domain':
                    url = '/api/admin/domains';
                    break;
                case 'server':
                    url = '/api/admin/servers';
                    break;
                default:
                    return;
            }

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.records && Array.isArray(data.records)) {
                        this.businessItems = data.records.map(item => {
                            let name = '';
                            if (table === 'account') {
                                name = item.uuid || item.id;
                            } else if (table === 'domain') {
                                name = item.domain || item.id;
                            } else if (table === 'server') {
                                name = item.ip + (item.name ? ` (${item.name})` : '');
                            }

                            return {
                                id: item.id,
                                name: name
                            };
                        });
                    } else {
                        this.businessItems = [];
                    }
                })
                .catch(error => {
                    console.error(`Error fetching ${table} items:`, error);
                    this.businessItems = [];
                });
        },

        fetchMonthlyStats() {
            fetch('/api/admin/transactions/monthly-stats?months=6')
                .then(response => response.json())
                .then(data => {
                    this.monthlyStats = data;
                    this.initTrendsChart();
                })
                .catch(error => {
                    console.error('Error fetching monthly stats:', error);
                });
        },

        initTrendsChart() {
            if (this.monthlyStats.length === 0) return;

            if (this.trendsChart) {
                this.trendsChart.destroy();
            }

            const months = this.monthlyStats.map(stat => stat.month);
            const incomeData = this.monthlyStats.map(stat => parseFloat(stat.income));
            const expenseData = this.monthlyStats.map(stat => parseFloat(stat.expense));
            const balanceData = this.monthlyStats.map(stat => parseFloat(stat.balance));

            const ctx = document.getElementById('trends-chart').getContext('2d');
            this.trendsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: '收入',
                            data: incomeData,
                            backgroundColor: 'rgba(40, 167, 69, 0.5)',
                            borderColor: 'rgba(40, 167, 69, 1)',
                            borderWidth: 1
                        },
                        {
                            label: '支出',
                            data: expenseData,
                            backgroundColor: 'rgba(220, 53, 69, 0.5)',
                            borderColor: 'rgba(220, 53, 69, 1)',
                            borderWidth: 1
                        },
                        {
                            label: '余额',
                            data: balanceData,
                            type: 'line',
                            backgroundColor: 'rgba(255, 193, 7, 0.5)',
                            borderColor: 'rgba(255, 193, 7, 1)',
                            borderWidth: 2,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        },

        searchDebounced() {
            // Clear existing timeout
            if (this.searchTimeout) {
                clearTimeout(this.searchTimeout);
            }

            // Set new timeout to delay the API call
            this.searchTimeout = setTimeout(() => {
                this.currentPage = 1; // Reset to first page when searching
                this.fetchTransactions();
            }, 500); // Wait for 500ms after user stops typing
        },

        formatDateTime(dateString) {
            if (!dateString) return null;
            const date = new Date(dateString);
            return date.toLocaleString();
        },

        formatCurrency(value) {
            if (value === null || value === undefined) return "0.00";
            return parseFloat(value).toFixed(2);
        },

        getTypeBadgeClass(type) {
            return type == 0 ? 'text-bg-success' : 'text-bg-danger';
        },

        getBusinessTableLabel(table) {
            const found = this.businessTables.find(t => t.value === table);
            return found ? found.label : table;
        },

        onBusinessTableChange() {
            this.newTransaction.businessId = '';
            this.fetchBusinessItems(this.newTransaction.businessTable);
        },

        onEditBusinessTableChange() {
            this.editedTransaction.businessId = '';
            this.fetchBusinessItems(this.editedTransaction.businessTable);
        },

        prevPage() {
            if (this.currentPage > 1) {
                this.currentPage--;
                this.fetchTransactions();
            }
        },

        nextPage() {
            if (this.currentPage < this.totalPages) {
                this.currentPage++;
                this.fetchTransactions();
            }
        },

        goToPage(page) {
            this.currentPage = page;
            this.fetchTransactions();
        },

        changePageSize() {
            this.currentPage = 1; // Reset to first page when changing page size
            this.fetchTransactions();
        },

        confirmDelete(transaction) {
            this.selectedTransaction = transaction;
            this.deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            this.deleteModal.show();
        },

        deleteTransaction() {
            if (!this.selectedTransaction) return;

            fetch(`/api/admin/transactions/${this.selectedTransaction.id}`, {
                method: 'DELETE'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('删除失败');
                    }

                    // Refetch the data to update the list and pagination
                    this.fetchTransactions();
                    this.fetchMonthlyStats();
                    ToastUtils.show('Success', '删除成功', 'success');

                    // Hide modal
                    this.deleteModal.hide();
                })
                .catch(error => {
                    console.error('Error:', error);
                    ToastUtils.show('Error', '删除失败', 'danger');
                });
        },

        // Create Transaction methods
        openCreateTransactionModal() {
            // 获取当前时间
            const now = new Date();
            const localDateTimeFormat = now.toISOString().slice(0, 16); // Format: YYYY-MM-DDTHH:MM

            // Reset form
            this.newTransaction = {
                transactionDate: localDateTimeFormat,
                amount: '',
                type: 0, // Default to income
                businessTable: '',
                businessId: '',
                description: '',
                paymentMethod: '',
                remark: ''
            };

            this.businessItems = [];
            this.validationErrors = {};

            // Show modal
            this.createModal = new bootstrap.Modal(document.getElementById('createTransactionModal'));
            this.createModal.show();
        },

        validateTransactionForm(transaction) {
            let isValid = true;
            this.validationErrors = {};

            // Validate transaction date
            if (!transaction.transactionDate) {
                this.validationErrors.transactionDate = '请选择交易日期';
                isValid = false;
            }

            // Validate amount
            if (!transaction.amount || parseFloat(transaction.amount) <= 0) {
                this.validationErrors.amount = '请输入有效金额';
                isValid = false;
            }

            // Validate description
            if (!transaction.description) {
                this.validationErrors.description = '请输入交易描述';
                isValid = false;
            }

            return isValid;
        },

        createTransaction() {
            if (!this.validateTransactionForm(this.newTransaction)) {
                return;
            }

            // Prepare data for API
            const transactionData = {
                transactionDate: this.newTransaction.transactionDate,
                amount: this.newTransaction.amount,
                type: parseInt(this.newTransaction.type),
                businessTable: this.newTransaction.businessTable || null,
                businessId: this.newTransaction.businessId || null,
                description: this.newTransaction.description,
                paymentMethod: this.newTransaction.paymentMethod || null,
                remark: this.newTransaction.remark || null
            };

            fetch('/api/admin/transactions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(transactionData)
            })
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 400) {
                            return response.json().then(data => {
                                throw new Error(data.message || 'Validation error');
                            });
                        }
                        throw new Error('响应失败');
                    }
                    return response.json();
                })
                .then(data => {
                    this.fetchTransactions(); // Refresh the list
                    this.fetchMonthlyStats(); // Refresh the stats
                    this.createModal.hide();
                    ToastUtils.show('Success', '创建成功', 'success');
                })
                .catch(error => {
                    console.error('Error:', error);
                    ToastUtils.show('Error', error.message || '创建失败', 'danger');
                });
        },

        // Edit Transaction methods
        openEditTransactionModal(transaction) {
            // Format dates for datetime-local input
            const formatDateForInput = (dateString) => {
                if (!dateString) return '';
                const date = new Date(dateString);
                return date.toISOString().slice(0, 16); // Format: YYYY-MM-DDTHH:MM
            };

            // Clone transaction data to avoid direct mutation
            this.editedTransaction = {
                id: transaction.id,
                transactionDate: formatDateForInput(transaction.transactionDate),
                amount: transaction.amount,
                type: transaction.type,
                businessTable: transaction.businessTable || '',
                businessId: transaction.businessId || '',
                description: transaction.description,
                paymentMethod: transaction.paymentMethod || '',
                remark: transaction.remark || ''
            };

            // Fetch related business items if needed
            if (transaction.businessTable) {
                this.fetchBusinessItems(transaction.businessTable);
            } else {
                this.businessItems = [];
            }

            this.validationErrors = {};

            // Show modal
            this.editModal = new bootstrap.Modal(document.getElementById('editTransactionModal'));
            this.editModal.show();
        },

        updateTransaction() {
            if (!this.validateTransactionForm(this.editedTransaction)) {
                return;
            }

            // Prepare data for API
            const transactionData = {
                transactionDate: this.editedTransaction.transactionDate,
                amount: this.editedTransaction.amount,
                type: parseInt(this.editedTransaction.type),
                businessTable: this.editedTransaction.businessTable || null,
                businessId: this.editedTransaction.businessId || null,
                description: this.editedTransaction.description,
                paymentMethod: this.editedTransaction.paymentMethod || null,
                remark: this.editedTransaction.remark || null
            };

            fetch(`/api/admin/transactions/${this.editedTransaction.id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(transactionData)
            })
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 400) {
                            return response.json().then(data => {
                                throw new Error(data.message || 'Validation error');
                            });
                        }
                        throw new Error('响应失败');
                    }
                    return response.json();
                })
                .then(data => {
                    this.fetchTransactions(); // Refresh the list
                    this.fetchMonthlyStats(); // Refresh the stats
                    this.editModal.hide();
                    ToastUtils.show('Success', '更新成功', 'success');
                })
                .catch(error => {
                    console.error('Error:', error);
                    ToastUtils.show('Error', error.message || '更新失败', 'danger');
                });
        }
    }).mount('#transactions-app');
</script>