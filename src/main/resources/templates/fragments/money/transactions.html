<div th:fragment="content" class="page-body">
    <div class="container-xl">
        <!-- Use the common data table template -->
        <div th:replace="~{fragments/common/data-table :: data-table(
            '交易流水',
            '添加交易',
            'transactions-app',
            'transactions',
            ~{fragments/money/transactions :: filters},
            ~{fragments/money/transactions :: table-content},
            ~{fragments/money/transactions :: stats-content},
            ~{fragments/money/transactions :: modals},
            'transaction-',
            true
        )}"></div>
    </div>
</div>

<!-- Filters Fragment -->
<th:block th:fragment="filters">
    <!-- Transaction type filter -->
    <div class="col-auto">
        <select class="form-select" v-model="filters.type" @change="fetchRecords">
            <option value="">全部类型</option>
            <option v-for="type in transactionTypes" :key="type.value" :value="type.value">{{ type.label }}</option>
        </select>
    </div>
    <!-- Business table filter -->
    <div class="col-auto">
        <select class="form-select" v-model="filters.businessTable" @change="fetchRecords">
            <option value="">全部业务</option>
            <option v-for="table in businessTables" :key="table.value" :value="table.value">{{ table.label }}</option>
        </select>
    </div>
</th:block>

<!-- Stats Content Fragment -->
<div th:fragment="stats-content" class="card-body border-bottom">
    <!-- 交易统计卡片 -->
    <div class="row">
        <div class="col-sm-6 col-lg-3">
            <div class="card card-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <span class="bg-primary text-white avatar">
                                <i class="ti ti-exchange"></i>
                            </span>
                        </div>
                        <div class="col">
                            <div class="font-weight-medium">
                                总交易金额
                            </div>
                            <div class="text-muted">
                                ¥ {{ formatCurrency(parseFloat(stats.totalIncome) + parseFloat(stats.totalExpense)) }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-lg-3">
            <div class="card card-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <span class="bg-green text-white avatar">
                                <i class="ti ti-arrow-up"></i>
                            </span>
                        </div>
                        <div class="col">
                            <div class="font-weight-medium">
                                总收入
                            </div>
                            <div class="text-muted">
                                ¥ {{ formatCurrency(stats.totalIncome) }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-lg-3">
            <div class="card card-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <span class="bg-red text-white avatar">
                                <i class="ti ti-arrow-down"></i>
                            </span>
                        </div>
                        <div class="col">
                            <div class="font-weight-medium">
                                总支出
                            </div>
                            <div class="text-muted">
                                ¥ {{ formatCurrency(stats.totalExpense) }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-lg-3">
            <div class="card card-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <span class="bg-yellow text-white avatar">
                                <i class="ti ti-wallet"></i>
                            </span>
                        </div>
                        <div class="col">
                            <div class="font-weight-medium">
                                净收入
                            </div>
                            <div class="text-muted" :class="parseFloat(stats.netBalance) >= 0 ? 'text-success' : 'text-danger'">
                                ¥ {{ formatCurrency(stats.netBalance) }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 收支趋势图 -->
    <div class="card-body border-bottom">
        <h3 class="card-title">收支趋势</h3>
        <div class="chart-container" style="height: 300px;">
            <canvas id="trends-chart" style="width: 100%; height: 100%"></canvas>
        </div>
    </div>
</div>

<!-- Table Content Fragment -->
<table th:fragment="table-content" class="table table-selectable card-table table-vcenter text-nowrap datatable">
    <thead>
    <tr>
        <th style="width: 10%">日期</th>
        <th style="width: 15%">金额</th>
        <th style="width: 10%">类型</th>
        <th style="width: 15%">关联业务</th>
        <th style="width: 20%">描述</th>
        <th style="width: 15%">支付方式</th>
        <th style="width: 15%">操作</th>
    </tr>
    </thead>
    <tbody>
    <tr v-for="transaction in records" :key="transaction.id">
        <td>{{ formatDateTime(transaction.transactionDate) }}</td>
        <td>
            <span :class="transaction.type == 0 ? 'text-success' : 'text-danger'">
                {{ transaction.type == 0 ? '+' : '-' }} ¥ {{ formatCurrency(transaction.amount) }}
            </span>
        </td>
        <td>
            <span class="badge" :class="getTypeBadgeClass(transaction.type)">
                {{ transaction.typeDescription }}
            </span>
        </td>
        <td>
            <div v-if="transaction.businessTable">
                {{ getBusinessTableLabel(transaction.businessTable) }}:
                <span class="text-muted">{{ transaction.businessName }}</span>
            </div>
            <span v-else>-</span>
        </td>
        <td>
            <div class="d-flex flex-column">
                <span v-text="transaction.description || '-'"></span>
                <span v-if="transaction.remark" class="text-muted small">{{ transaction.remark }}</span>
            </div>
        </td>
        <td v-text="transaction.paymentMethod || '-'"></td>
        <td>
            <div class="btn-list flex-nowrap">
                <div class="dropdown">
                    <button class="btn btn-sm dropdown-toggle align-text-top" data-bs-toggle="dropdown">
                        操作
                    </button>
                    <div class="dropdown-menu dropdown-menu-end">
                        <a class="dropdown-item" href="#" @click.prevent="openEditModal(transaction)">
                            <i class="ti ti-edit"></i> 编辑
                        </a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item text-danger" href="#" @click.prevent="confirmDelete(transaction)">
                            <i class="ti ti-trash"></i> 删除
                        </a>
                    </div>
                </div>
            </div>
        </td>
    </tr>
    <tr v-if="loading">
        <td colspan="7" class="text-center py-3">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </td>
    </tr>
    <tr v-else-if="records.length === 0">
        <td colspan="7" class="text-center py-3">没有查到数据.</td>
    </tr>
    </tbody>
</table>

<!-- Modals Fragment -->
<div th:fragment="modals">
    <!-- Create Transaction Modal -->
    <div class="modal modal-blur fade" id="createModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加交易</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label required">交易日期</label>
                                <input type="datetime-local" class="form-control" :class="{ 'is-invalid': validationErrors.transactionDate }" v-model="newItem.transactionDate">
                                <div class="invalid-feedback" v-if="validationErrors.transactionDate">{{ validationErrors.transactionDate }}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label required">交易类型</label>
                                <select class="form-select" :class="{ 'is-invalid': validationErrors.type }" v-model="newItem.type">
                                    <option v-for="type in transactionTypes" :key="type.value" :value="parseInt(type.value)">{{ type.label }}</option>
                                </select>
                                <div class="invalid-feedback" v-if="validationErrors.type">{{ validationErrors.type }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label required">金额</label>
                                <div class="input-group">
                                    <span class="input-group-text">¥</span>
                                    <input type="number" step="0.01" min="0" class="form-control" :class="{ 'is-invalid': validationErrors.amount }" v-model="newItem.amount">
                                </div>
                                <div class="invalid-feedback" v-if="validationErrors.amount">{{ validationErrors.amount }}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">支付方式</label>
                                <select class="form-select" :class="{ 'is-invalid': validationErrors.paymentMethod }" v-model="newItem.paymentMethod">
                                    <option v-for="type in paymentMethods" :key="type.value" :value="type.value">{{ type.label }}</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">关联业务类型</label>
                                <select class="form-select" v-model="newItem.businessTable" @change="onBusinessTableChange">
                                    <option value="">无关联业务</option>
                                    <option v-for="table in businessTables" :key="table.value" :value="table.value">{{ table.label }}</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">关联业务</label>
                                <select class="form-select" v-model="newItem.businessId" :disabled="!newItem.businessTable">
                                    <option value="">请选择</option>
                                    <option v-for="business in businessItems" :key="business.id" :value="business.id">{{ business.name }}</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label required">描述</label>
                        <input type="text" class="form-control" :class="{ 'is-invalid': validationErrors.description }" v-model="newItem.description">
                        <div class="invalid-feedback" v-if="validationErrors.description">{{ validationErrors.description }}</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">备注</label>
                        <textarea class="form-control" v-model="newItem.remark" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-link link-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" @click="createItem">创建</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div class="modal modal-blur fade" id="transaction-editModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑交易</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label required">交易日期</label>
                                <input type="datetime-local" class="form-control" :class="{ 'is-invalid': validationErrors.transactionDate }" v-model="editedItem.transactionDate">
                                <div class="invalid-feedback" v-if="validationErrors.transactionDate">{{ validationErrors.transactionDate }}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label required">交易类型</label>
                                <select class="form-select" :class="{ 'is-invalid': validationErrors.type }" v-model="editedItem.type">
                                    <option v-for="type in transactionTypes" :key="type.value" :value="parseInt(type.value)">{{ type.label }}</option>
                                </select>
                                <div class="invalid-feedback" v-if="validationErrors.type">{{ validationErrors.type }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label required">金额</label>
                                <div class="input-group">
                                    <span class="input-group-text">¥</span>
                                    <input type="number" step="0.01" min="0" class="form-control" :class="{ 'is-invalid': validationErrors.amount }" v-model="editedItem.amount">
                                </div>
                                <div class="invalid-feedback" v-if="validationErrors.amount">{{ validationErrors.amount }}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">支付方式</label>
                                <select class="form-select" :class="{ 'is-invalid': validationErrors.paymentMethod }" v-model="editedItem.paymentMethod">
                                    <option v-for="type in paymentMethods" :key="type.value" :value="type.value">{{ type.label }}</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">关联业务类型</label>
                                <select class="form-select" v-model="editedItem.businessTable" @change="onEditBusinessTableChange">
                                    <option value="">无关联业务</option>
                                    <option v-for="table in businessTables" :key="table.value" :value="table.value">{{ table.label }}</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">关联业务</label>
                                <select class="form-select" v-model="editedItem.businessId" :disabled="!editedItem.businessTable">
                                    <option value="">请选择</option>
                                    <option v-for="business in businessItems" :key="business.id" :value="business.id">{{ business.name }}</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label required">描述</label>
                        <input type="text" class="form-control" :class="{ 'is-invalid': validationErrors.description }" v-model="editedItem.description">
                        <div class="invalid-feedback" v-if="validationErrors.description">{{ validationErrors.description }}</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">备注</label>
                        <textarea class="form-control" v-model="editedItem.remark" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-link link-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" @click="updateItem">保存</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:fragment="script" th:inline="javascript" type="module">
    import { CommonDataTable } from '/static/js/CommonDataTable.js';
    // Transaction-specific implementation of the common data table
    const transactionTable = new CommonDataTable({
        data: {
            entityName: 'transactions',
            modalIdPrefix: 'transaction-',
            filters: {
                type: '',
                businessTable: ''
            },
            transactionTypes: [],
            paymentMethods: [],
            businessTables: [],
            businessItems: [],
            trendsChart: null,
            stats: {
                totalIncome: 0,
                totalExpense: 0,
                netBalance: 0,
                currentMonthIncome: 0,
                currentMonthExpense: 0
            },
            monthlyStats: [],
            newItem: {
                transactionDate: '',
                amount: '',
                type: 0, // Default to income
                businessTable: '',
                businessId: '',
                description: '',
                paymentMethod: '',
                remark: ''
            }
        },
        methods: {
            // Initialize data when the component is mounted
            initialize() {
                this.fetchTransactionTypes();
                this.fetchPaymentMethods();
                this.fetchBusinessTables();
                this.fetchMonthlyStats();

                // Set default transactionDate for new transaction
                const now = new Date();
                this.newItem.transactionDate = now.toISOString().slice(0, 16); // Format: YYYY-MM-DDTHH:MM
            },

            // After fetch hook
            afterFetch(data) {
                // Additional processing after data fetch if needed
            },

            // Format currency
            formatCurrency(value) {
                if (value === null || value === undefined) return "0.00";
                return parseFloat(value).toFixed(2);
            },

            // Get Badge classes
            getTypeBadgeClass(type) {
                return type == 0 ? 'text-bg-success' : 'text-bg-danger';
            },

            getBusinessTableLabel(table) {
                const found = this.businessTables.find(t => t.value === table);
                return found ? found.label : table;
            },

            // Load transaction types
            fetchTransactionTypes() {
                fetch('/api/admin/transactions/types')
                    .then(response => response.json())
                    .then(data => {
                        this.transactionTypes = data;
                    })
                    .catch(error => {
                        console.error('Error fetching transaction types:', error);
                    });
            },

            // Load paymentMethods
            fetchPaymentMethods() {
                fetch('/api/admin/transactions/paymentMethods')
                    .then(response => response.json())
                    .then(data => {
                        this.paymentMethods = data;
                    })
                    .catch(error => {
                        console.error('Error fetching paymentMethods:', error);
                    });
            },

            // Load business tables
            fetchBusinessTables() {
                fetch('/api/admin/transactions/business-tables')
                    .then(response => response.json())
                    .then(data => {
                        this.businessTables = data;
                    })
                    .catch(error => {
                        console.error('Error fetching business tables:', error);
                    });
            },

            // Load related business items based on selected business table
            fetchBusinessItems(table) {
                if (!table) {
                    this.businessItems = [];
                    return;
                }

                let url = '';
                switch (table) {
                    case 'account':
                        url = '/api/admin/accounts';
                        break;
                    case 'domain':
                        url = '/api/admin/domains';
                        break;
                    case 'server':
                        url = '/api/admin/servers';
                        break;
                    default:
                        return;
                }

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        if (data.records && Array.isArray(data.records)) {
                            this.businessItems = data.records.map(item => {
                                let name = '';
                                if (table === 'account') {
                                    name = item.uuid || item.id;
                                } else if (table === 'domain') {
                                    name = item.domain || item.id;
                                } else if (table === 'server') {
                                    name = item.ip + (item.name ? ` (${item.name})` : '');
                                }

                                return {
                                    id: item.id,
                                    name: name
                                };
                            });
                        } else {
                            this.businessItems = [];
                        }
                    })
                    .catch(error => {
                        console.error(`Error fetching ${table} items:`, error);
                        this.businessItems = [];
                    });
            },

            // Fetch monthly stats and initialize chart
            fetchMonthlyStats() {
                fetch('/api/admin/transactions/monthly-stats?months=6')
                    .then(response => response.json())
                    .then(data => {
                        this.monthlyStats = data;
                        this.initTrendsChart();
                    })
                    .catch(error => {
                        console.error('Error fetching monthly stats:', error);
                    });
            },

            // Initialize trends chart
            initTrendsChart() {
                if (this.monthlyStats.length === 0) return;

                if (this.trendsChart) {
                    this.trendsChart.destroy();
                }

                const months = this.monthlyStats.map(stat => stat.month);
                const incomeData = this.monthlyStats.map(stat => parseFloat(stat.income));
                const expenseData = this.monthlyStats.map(stat => parseFloat(stat.expense));
                const balanceData = this.monthlyStats.map(stat => parseFloat(stat.balance));

                const ctx = document.getElementById('trends-chart').getContext('2d');
                this.trendsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: '收入',
                                data: incomeData,
                                backgroundColor: 'rgba(40, 167, 69, 0.5)',
                                borderColor: 'rgba(40, 167, 69, 1)',
                                borderWidth: 1
                            },
                            {
                                label: '支出',
                                data: expenseData,
                                backgroundColor: 'rgba(220, 53, 69, 0.5)',
                                borderColor: 'rgba(220, 53, 69, 1)',
                                borderWidth: 1
                            },
                            {
                                label: '余额',
                                data: balanceData,
                                type: 'line',
                                backgroundColor: 'rgba(255, 193, 7, 0.5)',
                                borderColor: 'rgba(255, 193, 7, 1)',
                                borderWidth: 2,
                                fill: false
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            },

            // Handle business table change event
            onBusinessTableChange() {
                this.newItem.businessId = '';
                this.fetchBusinessItems(this.newItem.businessTable);
            },

            // Handle edit business table change event
            onEditBusinessTableChange() {
                this.editedItem.businessId = '';
                this.fetchBusinessItems(this.editedItem.businessTable);
            },

            // Form validation and preparation
            validateCreateForm() {
                let isValid = true;
                this.validationErrors = {};

                // Validate transaction date
                if (!this.newItem.transactionDate) {
                    this.validationErrors.transactionDate = '请选择交易日期';
                    isValid = false;
                }

                // Validate amount
                if (!this.newItem.amount || parseFloat(this.newItem.amount) <= 0) {
                    this.validationErrors.amount = '请输入有效金额';
                    isValid = false;
                }

                // Validate description
                if (!this.newItem.description) {
                    this.validationErrors.description = '请输入交易描述';
                    isValid = false;
                }

                return isValid;
            },

            validateEditForm() {
                let isValid = true;
                this.validationErrors = {};

                // Validate transaction date
                if (!this.editedItem.transactionDate) {
                    this.validationErrors.transactionDate = '请选择交易日期';
                    isValid = false;
                }

                // Validate amount
                if (!this.editedItem.amount || parseFloat(this.editedItem.amount) <= 0) {
                    this.validationErrors.amount = '请输入有效金额';
                    isValid = false;
                }

                // Validate description
                if (!this.editedItem.description) {
                    this.validationErrors.description = '请输入交易描述';
                    isValid = false;
                }

                return isValid;
            },

            prepareCreateData() {
                return {
                    transactionDate: this.newItem.transactionDate,
                    amount: this.newItem.amount,
                    type: parseInt(this.newItem.type),
                    businessTable: this.newItem.businessTable || null,
                    businessId: this.newItem.businessId || null,
                    description: this.newItem.description,
                    paymentMethod: this.newItem.paymentMethod || null,
                    remark: this.newItem.remark || null
                };
            },

            prepareUpdateData() {
                return {
                    transactionDate: this.editedItem.transactionDate,
                    amount: this.editedItem.amount,
                    type: parseInt(this.editedItem.type),
                    businessTable: this.editedItem.businessTable || null,
                    businessId: this.editedItem.businessId || null,
                    description: this.editedItem.description,
                    paymentMethod: this.editedItem.paymentMethod || null,
                    remark: this.editedItem.remark || null
                };
            },

            resetCreateForm() {
                // Get current time for default date
                const now = new Date();
                const localDateTimeFormat = now.toISOString().slice(0, 16); // Format: YYYY-MM-DDTHH:MM

                this.newItem = {
                    transactionDate: localDateTimeFormat,
                    amount: '',
                    type: 0, // Default to income
                    businessTable: '',
                    businessId: '',
                    description: '',
                    paymentMethod: '',
                    remark: ''
                };

                this.businessItems = [];
            },

            prepareEditForm(transaction) {
                // Format dates for datetime-local input
                const formatDateForInput = (dateString) => {
                    if (!dateString) return '';
                    const date = new Date(dateString);
                    return date.toISOString().slice(0, 16); // Format: YYYY-MM-DDTHH:MM
                };

                // Clone transaction data
                const editedData = {
                    id: transaction.id,
                    transactionDate: formatDateForInput(transaction.transactionDate),
                    amount: transaction.amount,
                    type: transaction.type,
                    businessTable: transaction.businessTable || '',
                    businessId: transaction.businessId || '',
                    description: transaction.description,
                    paymentMethod: transaction.paymentMethod || '',
                    remark: transaction.remark || ''
                };

                // Fetch related business items if needed
                if (transaction.businessTable) {
                    this.fetchBusinessItems(transaction.businessTable);
                } else {
                    this.businessItems = [];
                }

                return editedData;
            },

            // Hooks for after create/update
            afterCreate(data) {
                this.fetchMonthlyStats(); // Refresh the chart
            },

            afterUpdate(data) {
                this.fetchMonthlyStats(); // Refresh the chart
            },

            // URLs for API calls
            getApiUrl() {
                return '/api/admin/transactions';
            }
        }
    });

    // Initialize the Vue app
    transactionTable.createApp('#transactions-app');
</script>