<div th:fragment="content" class="page-body">
    <div class="container-xl">
        <!-- Use the common data table template -->
        <div th:replace="~{fragments/common/data-table :: data-table(
            '账户管理',
            '添加账户',
            'accounts-app',
            'accounts',
            ~{fragments/person/account :: filters},
            ~{fragments/person/account :: table-content},
            ~{fragments/person/account :: stats-cards},
            ~{fragments/person/account :: modals},
            'account-',
            true
        )}"></div>
    </div>
</div>

<!-- Filters Fragment -->
<th:block th:fragment="filters">
    <!-- User filter -->
    <div class="col-auto">
        <select class="form-select" v-model="filters.userId" @change="fetchRecords">
            <option value="">全部用户</option>
            <option v-for="user in users" :key="user.id" :value="user.id">{{ user.email || user.nickName }}</option>
        </select>
    </div>
    <!-- Status filter -->
    <div class="col-auto">
        <select class="form-select" v-model="filters.status" @change="fetchRecords">
            <option value="">全部状态</option>
            <option value="active">活跃</option>
            <option value="expired">已过期</option>
            <option value="disabled">已禁用</option>
        </select>
    </div>
</th:block>

<!-- Stats Cards Fragment -->
<div th:fragment="stats-cards" class="card-body border-bottom">
    <div class="row">
        <div class="col-sm-6 col-lg-3">
            <div class="card card-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <span class="bg-primary text-white avatar">
                                <i class="ti ti-device-desktop"></i>
                            </span>
                        </div>
                        <div class="col">
                            <div class="font-weight-medium">
                                总账户数
                            </div>
                            <div class="text-muted">
                                {{ stats.total || 0 }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-lg-3">
            <div class="card card-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <span class="bg-green text-white avatar">
                                <i class="ti ti-circle-check"></i>
                            </span>
                        </div>
                        <div class="col">
                            <div class="font-weight-medium">
                                活跃账户
                            </div>
                            <div class="text-muted">
                                {{ stats.active || 0 }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-lg-3">
            <div class="card card-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <span class="bg-red text-white avatar">
                                <i class="ti ti-calendar-x"></i>
                            </span>
                        </div>
                        <div class="col">
                            <div class="font-weight-medium">
                                已过期
                            </div>
                            <div class="text-muted">
                                {{ stats.expired || 0 }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-lg-3">
            <div class="card card-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <span class="bg-yellow text-white avatar">
                                <i class="ti ti-clock"></i>
                            </span>
                        </div>
                        <div class="col">
                            <div class="font-weight-medium">
                                即将过期
                            </div>
                            <div class="text-muted">
                                {{ stats.expiringSoon || 0 }} (7天内)
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Table Content Fragment -->
<table th:fragment="table-content" class="table table-selectable card-table table-vcenter text-nowrap datatable">
    <thead>
    <tr>
        <th>ID</th>
        <th>用户</th>
        <th>UUID</th>
        <th>状态</th>
        <th>流量使用</th>
        <th>到期时间</th>
        <th>创建时间</th>
        <th class="w-1">操作</th>
    </tr>
    </thead>
    <tbody>
    <tr v-for="account in records" :key="account.id">
        <td v-text="account.id"></td>
        <td>
            <a href="#" @click.prevent="viewUserDetails(account.userId)">{{ account.userEmail || account.userId }}</a>
        </td>
        <td>
            <div class="d-flex align-items-center">
                <span v-text="account.uuid" class="text-truncate" style="max-width: 150px;"></span>
                <button @click="copyToClipboard(account.uuid)" class="btn btn-sm btn-ghost-secondary ms-2">
                    <i class="ti ti-copy"></i>
                </button>
            </div>
        </td>
        <td>
            <span class="badge" :class="getStatusBadgeClass(account.statusType)">
                {{ account.statusDescription }}
            </span>
        </td>
        <td>
            <div v-if="account.bandwidth">
                <div class="row align-items-center">
                    <div class="col-auto">
                        {{ formatBytes(account.totalUsedBytes) }} / {{ account.bandwidth }} GB
                    </div>
                    <div class="col">
                        <div class="progress progress-sm">
                            <div class="progress-bar" :class="getProgressBarClass(account.usagePercentage)" :style="{ width: account.usagePercentage + '%' }"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div v-else>
                {{ formatBytes(account.totalUsedBytes) }}
            </div>
        </td>
        <td v-text="formatDateTime(account.toDate) || '永不过期'"></td>
        <td v-text="formatDateTime(account.createTime)"></td>
        <td>
            <div class="btn-list flex-nowrap">
                <div class="dropdown position-static">
                    <button class="btn btn-sm dropdown-toggle align-text-top" data-bs-toggle="dropdown">
                        操作
                    </button>
                    <div class="dropdown-menu dropdown-menu-end">
                        <a class="dropdown-item" href="#" @click.prevent="openEditModal(account)">
                            <i class="ti ti-edit"></i> 编辑
                        </a>
                        <a class="dropdown-item" href="#" @click.prevent="openConfigUrlModal(account)">
                            <i class="ti ti-link"></i> 配置链接
                        </a>
                        <a class="dropdown-item" href="#" @click.prevent="openRenewAccountModal(account)">
                            <i class="ti ti-calendar-plus"></i> 续期
                        </a>
                        <a class="dropdown-item" href="#" @click.prevent="resetAuthCode(account)">
                            <i class="ti ti-refresh"></i> 重置认证码
                        </a>
                        <a v-if="account.statusType === 'active'" class="dropdown-item" href="#" @click.prevent="toggleItemStatus(account, true)">
                            <i class="ti ti-ban"></i> 禁用
                        </a>
                        <a v-else class="dropdown-item" href="#" @click.prevent="toggleItemStatus(account, false)">
                            <i class="ti ti-check"></i> 启用
                        </a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item text-danger" href="#" @click.prevent="confirmDelete(account)">
                            <i class="ti ti-trash"></i> 删除
                        </a>
                    </div>
                </div>
            </div>
        </td>
    </tr>
    <tr v-if="loading">
        <td colspan="8" class="text-center py-3">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </td>
    </tr>
    <tr v-else-if="records.length === 0">
        <td colspan="8" class="text-center py-3">没有查到数据.</td>
    </tr>
    </tbody>
</table>

<!-- All Modals Fragment -->
<div th:fragment="modals">
    <!-- Create Account Modal -->
    <div class="modal modal-blur fade" id="createModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加账户</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label required">用户</label>
                                <select class="form-select" :class="{ 'is-invalid': validationErrors.userId }" v-model="newItem.userId">
                                    <option v-for="user in users" :key="user.id" :value="user.id">{{ user.email || user.nickName }}</option>
                                </select>
                                <div class="invalid-feedback" v-if="validationErrors.userId">{{ validationErrors.userId }}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">级别</label>
                                <input type="number" class="form-control" v-model="newItem.level" min="0">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">UUID</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" v-model="newItem.uuid" placeholder="留空自动生成">
                                    <button class="btn" type="button" @click="generateUuid">生成</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">认证码</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" v-model="newItem.authCode" placeholder="留空自动生成">
                                    <button class="btn" type="button" @click="generateAuthCode">生成</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">开始时间</label>
                                <input type="datetime-local" class="form-control" v-model="newItem.fromDate">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">到期时间</label>
                                <input type="datetime-local" class="form-control" v-model="newItem.toDate">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label required">统计周期类型</label>
                                <select class="form-select" :class="{ 'is-invalid': validationErrors.periodType }" v-model="newItem.periodType">
                                    <option v-for="type in periodTypes" :key="type.value" :value="type.value">{{ type.label }}</option>
                                </select>
                                <div class="invalid-feedback" v-if="validationErrors.periodType">{{ validationErrors.periodType }}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">最大在线IP数</label>
                                <input type="number" class="form-control" v-model="newItem.maxOnlineIps" min="0">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">最大速度 (预留字段)</label>
                                <input type="number" class="form-control" v-model="newItem.speed" min="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">流量限制 (GB)</label>
                                <input type="number" class="form-control" v-model="newItem.bandwidth" min="0">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" v-model="newItem.disabled">
                            <span class="form-check-label">禁用账户</span>
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-link link-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" @click="createItem">创建</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Account Modal -->
    <div class="modal modal-blur fade" id="account-editModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑账户</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label required">用户</label>
                                <select class="form-select" :class="{ 'is-invalid': validationErrors.userId }" v-model="editedItem.userId">
                                    <option v-for="user in users" :key="user.id" :value="user.id">{{ user.email || user.nickName }}</option>
                                </select>
                                <div class="invalid-feedback" v-if="validationErrors.userId">{{ validationErrors.userId }}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">级别</label>
                                <input type="number" class="form-control" v-model="editedItem.level" min="0">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">UUID</label>
                                <input type="text" class="form-control" v-model="editedItem.uuid" readonly>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">认证码</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" v-model="editedItem.authCode" readonly>
                                    <button class="btn" type="button" @click="regenerateAuthCode">重新生成</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">开始时间</label>
                                <input type="datetime-local" class="form-control" v-model="editedItem.fromDate">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">到期时间</label>
                                <input type="datetime-local" class="form-control" v-model="editedItem.toDate">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label required">统计周期类型</label>
                                <select class="form-select" :class="{ 'is-invalid': validationErrors.periodType }" v-model="editedItem.periodType">
                                    <option v-for="type in periodTypes" :key="type.value" :value="type.value">{{ type.label }}</option>
                                </select>
                                <div class="invalid-feedback" v-if="validationErrors.periodType">{{ validationErrors.periodType }}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">最大在线IP数</label>
                                <input type="number" class="form-control" v-model="editedItem.maxOnlineIps" min="0">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">最大速度 (预留字段)</label>
                                <input type="number" class="form-control" v-model="editedItem.speed" min="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">流量限制 (GB)</label>
                                <input type="number" class="form-control" v-model="editedItem.bandwidth" min="0">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" :checked="editedItem.disabled === 1" @change="editedItem.disabled = $event.target.checked ? 1 : 0">
                            <span class="form-check-label">禁用账户</span>
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-link link-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" @click="updateItem">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Config URL Modal -->
    <div class="modal modal-blur fade" id="configUrlModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">配置链接</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">配置链接</label>
                        <div class="input-group">
                            <input type="text" class="form-control" v-model="configUrl" readonly>
                            <button class="btn" type="button" @click="copyToClipboard(configUrl)">复制</button>
                        </div>
                        <small class="form-hint">用户可以通过此链接获取配置信息</small>
                    </div>
                    <div v-if="selectedItem" class="alert" :class="getStatusAlertClass(selectedItem.statusType)">
                        <div class="d-flex">
                            <div>
                                <i class="ti ti-info-circle"></i>
                            </div>
                            <div class="ms-2">
                                账户状态：{{ selectedItem.statusDescription }}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-link link-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Renew Account Modal -->
    <div class="modal modal-blur fade" id="renewAccountModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">续期账户</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div v-if="selectedItem" class="alert" :class="getStatusAlertClass(selectedItem.statusType)">
                        <div class="d-flex">
                            <div>
                                <i class="ti ti-info-circle"></i>
                            </div>
                            <div class="ms-2">
                                当前状态：{{ selectedItem.statusDescription }}
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label required">新到期时间</label>
                        <input type="datetime-local" class="form-control" :class="{ 'is-invalid': validationErrors.expiryDate }" v-model="renewData.expiryDate">
                        <div class="invalid-feedback" v-if="validationErrors.expiryDate">{{ validationErrors.expiryDate }}</div>
                    </div>
                    <div class="mb-3">
                        <div class="btn-list">
                            <button type="button" class="btn btn-outline-secondary" @click="setRenewPeriod(1, 'months')">+1个月</button>
                            <button type="button" class="btn btn-outline-secondary" @click="setRenewPeriod(3, 'months')">+3个月</button>
                            <button type="button" class="btn btn-outline-secondary" @click="setRenewPeriod(6, 'months')">+6个月</button>
                            <button type="button" class="btn btn-outline-secondary" @click="setRenewPeriod(1, 'years')">+1年</button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-link link-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" @click="renewAccount">续期</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:fragment="script" th:inline="javascript" type="module">
    import { CommonDataTable } from '/static/js/CommonDataTable.js';
    // Account-specific implementation of the common data table
    const accountTable = new CommonDataTable({
        data: {
            entityName: 'accounts',
            modalIdPrefix: 'account-',
            filters: {
                userId: '',
                status: ''
            },
            users: [],
            periodTypes: [],
            stats: {
                total: 0,
                active: 0,
                expired: 0,
                disabled: 0,
                expiringSoon: 0
            },
            configUrl: '',
            configUrlModal: null,
            renewModal: null,
            renewData: {
                expiryDate: ''
            },
            newItem: {
                userId: '',
                level: 0,
                fromDate: '',
                toDate: '',
                periodType: 'MONTHLY',
                uuid: '',
                authCode: '',
                maxOnlineIps: 0,
                speed: 0,
                bandwidth: 0,
                disabled: false
            }
        },
        methods: {
            // Initialize any additional data
            initialize() {
                this.fetchUsers();
                this.fetchPeriodTypes();
            },

            // Fetch additional data
            fetchUsers() {
                fetch('/api/admin/users')
                    .then(response => response.json())
                    .then(data => {
                        this.users = data.records;

                        // If it's the first load and no user selected, select the first one
                        if (this.users.length > 0 && !this.newItem.userId) {
                            this.newItem.userId = this.users[0].id;
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching users:', error);
                    });
            },

            fetchPeriodTypes() {
                fetch('/api/admin/accounts/period-types')
                    .then(response => response.json())
                    .then(data => {
                        this.periodTypes = data;
                    })
                    .catch(error => {
                        console.error('Error fetching period types:', error);
                    });
            },

            // Get Badge classes
            getStatusBadgeClass(statusType) {
                switch (statusType) {
                    case 'active': return 'text-bg-success';
                    case 'expired': return 'text-bg-danger';
                    case 'disabled': return 'text-bg-secondary';
                    default: return 'text-bg-secondary';
                }
            },

            getStatusAlertClass(statusType) {
                switch (statusType) {
                    case 'active': return 'alert-success';
                    case 'expired': return 'alert-danger';
                    case 'disabled': return 'alert-secondary';
                    default: return 'alert-secondary';
                }
            },

            getProgressBarClass(percentage) {
                if (percentage >= 90) return 'bg-danger';
                if (percentage >= 70) return 'bg-warning';
                return 'bg-success';
            },

            // Navigation and UI actions
            viewUserDetails(userId) {
                // Redirect to user details page
                window.location.href = `/admin/users/${userId}`;
            },

            // UUID and Auth code management
            generateUuid() {
                this.newItem.uuid = this.uuidv4();
            },

            generateAuthCode() {
                this.newItem.authCode = this.generateRandomString(16);
            },

            regenerateAuthCode() {
                if (!this.editedItem.id) return;

                fetch(`/api/admin/accounts/${this.editedItem.id}/reset-auth`, {
                    method: 'PATCH'
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('重置认证码失败');
                        }
                        return response.json();
                    })
                    .then(data => {
                        this.editedItem.authCode = data.authCode;
                        ToastUtils.show('Success', '重置认证码成功', 'success');
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        ToastUtils.show('Error', '重置认证码失败', 'danger');
                    });
            },

            resetAuthCode(account) {
                if (!account.id) return;

                fetch(`/api/admin/accounts/${account.id}/reset-auth`, {
                    method: 'PATCH'
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('重置认证码失败');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Update the auth code in the local records array
                        const index = this.records.findIndex(a => a.id === account.id);
                        if (index !== -1) {
                            this.records[index].authCode = data.authCode;
                        }
                        ToastUtils.show('Success', '重置认证码成功', 'success');
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        ToastUtils.show('Error', '重置认证码失败', 'danger');
                    });
            },

            // Config URL modal methods
            openConfigUrlModal(account) {
                this.selectedItem = account;

                fetch(`/api/admin/accounts/${account.id}/config-url`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('获取配置链接失败');
                        }
                        return response.json();
                    })
                    .then(data => {
                        this.configUrl = data.configUrl;
                        this.configUrlModal = new bootstrap.Modal(document.getElementById('configUrlModal'));
                        this.configUrlModal.show();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        ToastUtils.show('Error', '获取配置链接失败', 'danger');
                    });
            },

            // Renew account methods
            openRenewAccountModal(account) {
                this.selectedItem = account;

                // Calculate default renewal time (from current time or expiry time +1 month)
                let baseDate;
                if (account.toDate && new Date(account.toDate) > new Date()) {
                    baseDate = new Date(account.toDate);
                } else {
                    baseDate = new Date();
                }

                // Add one month
                baseDate.setMonth(baseDate.getMonth() + 1);
                this.renewData = {
                    expiryDate: baseDate.toISOString().slice(0, 16) // Format: YYYY-MM-DDTHH:MM
                };

                this.validationErrors = {};
                this.renewModal = new bootstrap.Modal(document.getElementById('renewAccountModal'));
                this.renewModal.show();
            },

            setRenewPeriod(value, unit) {
                // Calculate new renewal time (from current time or expiry time)
                let baseDate;
                if (this.selectedItem.toDate && new Date(this.selectedItem.toDate) > new Date()) {
                    baseDate = new Date(this.selectedItem.toDate);
                } else {
                    baseDate = new Date();
                }

                // Add time based on unit
                if (unit === 'days') {
                    baseDate.setDate(baseDate.getDate() + value);
                } else if (unit === 'months') {
                    baseDate.setMonth(baseDate.getMonth() + value);
                } else if (unit === 'years') {
                    baseDate.setFullYear(baseDate.getFullYear() + value);
                }

                this.renewData.expiryDate = baseDate.toISOString().slice(0, 16);
            },

            validateRenewForm() {
                let isValid = true;
                this.validationErrors = {};

                if (!this.renewData.expiryDate) {
                    this.validationErrors.expiryDate = '请选择到期时间';
                    isValid = false;
                } else {
                    const expiryDate = new Date(this.renewData.expiryDate);
                    const now = new Date();
                    if (expiryDate <= now) {
                        this.validationErrors.expiryDate = '到期时间必须大于当前时间';
                        isValid = false;
                    }
                }

                return isValid;
            },

            renewAccount() {
                if (!this.validateRenewForm()) {
                    return;
                }

                fetch(`/api/admin/accounts/${this.selectedItem.id}/renew?expiryDate=${encodeURIComponent(this.renewData.expiryDate)}`, {
                    method: 'PATCH'
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('续期失败');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Update the account in the local records array
                        const index = this.records.findIndex(a => a.id === this.selectedItem.id);
                        if (index !== -1) {
                            this.records[index] = data;
                        }

                        this.renewModal.hide();
                        ToastUtils.show('Success', '续期成功', 'success');
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        ToastUtils.show('Error', '续期失败', 'danger');
                    });
            },

            // Form validation and preparation
            validateCreateForm() {
                let isValid = true;
                this.validationErrors = {};

                // UserID validation
                if (!this.newItem.userId) {
                    this.validationErrors.userId = '请选择用户';
                    isValid = false;
                }

                // PeriodType validation
                if (!this.newItem.periodType) {
                    this.validationErrors.periodType = '请选择统计周期类型';
                    isValid = false;
                }

                return isValid;
            },

            validateEditForm() {
                let isValid = true;
                this.validationErrors = {};

                // UserID validation
                if (!this.editedItem.userId) {
                    this.validationErrors.userId = '请选择用户';
                    isValid = false;
                }

                // PeriodType validation
                if (!this.editedItem.periodType) {
                    this.validationErrors.periodType = '请选择统计周期类型';
                    isValid = false;
                }

                return isValid;
            },

            prepareCreateData() {
                // Get current time
                const now = new Date();
                const localDateTimeFormat = now.toISOString().slice(0, 16); // Format: YYYY-MM-DDTHH:MM

                // Get one month later for default expiration
                const oneMonthLater = new Date();
                oneMonthLater.setMonth(oneMonthLater.getMonth() + 1);
                const oneMonthLaterFormat = oneMonthLater.toISOString().slice(0, 16);

                return {
                    userId: this.newItem.userId,
                    level: this.newItem.level || null,
                    fromDate: this.newItem.fromDate || localDateTimeFormat,
                    toDate: this.newItem.toDate || oneMonthLaterFormat,
                    periodType: this.newItem.periodType,
                    uuid: this.newItem.uuid || null, // Will be generated on server if null
                    authCode: this.newItem.authCode || null, // Will be generated on server if null
                    maxOnlineIps: this.newItem.maxOnlineIps || null,
                    speed: this.newItem.speed || null,
                    bandwidth: this.newItem.bandwidth || null,
                    disabled: this.newItem.disabled ? 1 : 0
                };
            },

            prepareUpdateData() {
                return {
                    userId: this.editedItem.userId,
                    level: this.editedItem.level,
                    fromDate: this.editedItem.fromDate || null,
                    toDate: this.editedItem.toDate || null,
                    periodType: this.editedItem.periodType,
                    maxOnlineIps: this.editedItem.maxOnlineIps,
                    speed: this.editedItem.speed,
                    bandwidth: this.editedItem.bandwidth,
                    disabled: this.editedItem.disabled
                };
            },

            resetCreateForm() {
                // Get current time
                const now = new Date();
                const localDateTimeFormat = now.toISOString().slice(0, 16); // Format: YYYY-MM-DDTHH:MM

                // Get one month later for default expiration
                const oneMonthLater = new Date();
                oneMonthLater.setMonth(oneMonthLater.getMonth() + 1);
                const oneMonthLaterFormat = oneMonthLater.toISOString().slice(0, 16);

                this.newItem = {
                    userId: this.users.length > 0 ? this.users[0].id : '',
                    level: 0,
                    fromDate: localDateTimeFormat,
                    toDate: oneMonthLaterFormat,
                    periodType: 'MONTHLY',
                    uuid: '',
                    authCode: '',
                    maxOnlineIps: 0,
                    speed: 0,
                    bandwidth: 0,
                    disabled: false
                };
            },

            prepareEditForm(account) {
                // Format dates for datetime-local input
                const formatDateForInput = (dateString) => {
                    if (!dateString) return '';
                    const date = new Date(dateString);
                    return date.toISOString().slice(0, 16); // Format: YYYY-MM-DDTHH:MM
                };

                return {
                    id: account.id,
                    userId: account.userId,
                    level: account.level,
                    fromDate: formatDateForInput(account.fromDate),
                    toDate: formatDateForInput(account.toDate),
                    periodType: account.periodType,
                    uuid: account.uuid,
                    authCode: account.authCode,
                    maxOnlineIps: account.maxOnlineIps,
                    speed: account.speed,
                    bandwidth: account.bandwidth,
                    disabled: account.disabled
                };
            },

            // URLs for API calls
            getApiUrl() {
                return '/api/admin/accounts';
            },

            getToggleStatusUrl(item, action) {
                return `/api/admin/accounts/${item.id}/${action}`;
            }
        }
    });

    // Initialize the Vue app
    accountTable.createApp('#accounts-app');
</script>