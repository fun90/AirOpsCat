<th:block th:fragment="header" >
    <th:block th:replace="~{fragments/common/header :: header(
        ${pageTitle},
        ${pageSecondaryTitle},
        true,
        ~{}
    )}"></th:block>
</th:block>

<div th:fragment="content" class="page-body">
    <div class="container-xl">
        <!-- Use the common data table template -->
        <div th:replace="~{fragments/common/data-table :: data-table(
            '流量统计',
            'traffic-stats',
            ~{fragments/person/account-traffic :: filters},
            ~{fragments/person/account-traffic :: table-content},
            ~{fragments/person/account-traffic :: stats-cards},
            ~{fragments/person/account-traffic :: modals},
            'traffic-stats-'
        )}"></div>
    </div>
</div>

<!-- Filters Fragment -->
<th:block th:fragment="filters">
    <!-- User filter -->
    <div class="col-auto">
        <select class="form-select" v-model="filters.userId" @change="fetchRecords">
            <option value="">全部用户</option>
            <option v-for="user in users" :key="user.id" :value="user.id">{{ user.email || user.nickName }}</option>
        </select>
    </div>
    <!-- Date filters -->
    <div class="col-auto">
        <div class="input-group">
            <span class="input-group-text">开始日期</span>
            <input type="date" class="form-control" v-model="filters.startDate" @change="fetchRecords">
        </div>
    </div>
    <div class="col-auto">
        <div class="input-group">
            <span class="input-group-text">结束日期</span>
            <input type="date" class="form-control" v-model="filters.endDate" @change="fetchRecords">
        </div>
    </div>
</th:block>

<!-- Stats Cards Fragment -->
<div th:fragment="stats-cards" class="card-body border-bottom" v-if="filters.userId">
    <div class="row">
        <div class="col-md-6 col-xl-3">
            <div class="card card-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <span class="bg-blue text-white avatar">
                                <i class="ti ti-arrow-up"></i>
                            </span>
                        </div>
                        <div class="col">
                            <div class="font-weight-medium">
                                上传流量
                            </div>
                            <div class="text-muted">
                                {{ totalUploadFormatted }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-xl-3">
            <div class="card card-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <span class="bg-green text-white avatar">
                                <i class="ti ti-arrow-down"></i>
                            </span>
                        </div>
                        <div class="col">
                            <div class="font-weight-medium">
                                下载流量
                            </div>
                            <div class="text-muted">
                                {{ totalDownloadFormatted }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-xl-3">
            <div class="card card-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <span class="bg-purple text-white avatar">
                                <i class="ti ti-exchange"></i>
                            </span>
                        </div>
                        <div class="col">
                            <div class="font-weight-medium">
                                总流量
                            </div>
                            <div class="text-muted">
                                {{ formatBytes(totalUpload + totalDownload) }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Table Content Fragment -->
<div th:fragment="table-content" class="card-body p-0">
                <table class="table table-vcenter card-table">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>人员</th>
                        <th>账户ID</th>
                        <th>开始时间</th>
                        <th>结束时间</th>
                        <th>上传流量</th>
                        <th>下载流量</th>
                        <th>总流量</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr v-for="record in records" :key="record.id">
                        <td v-text="record.id"></td>
                        <td>
                            <span v-if="getUserEmail(record.userId)">{{ getUserEmail(record.userId) }}</span>
                            <span v-else>{{ record.userId }}</span>
                        </td>
                        <td v-text="record.accountId"></td>
                        <td v-text="formatDate(record.periodStart)"></td>
                        <td v-text="formatDate(record.periodEnd)"></td>
                        <td v-text="formatBytes(record.uploadBytes)"></td>
                        <td v-text="formatBytes(record.downloadBytes)"></td>
                        <td v-text="formatBytes(record.uploadBytes + record.downloadBytes)"></td>
                        <td>
                            <div class="btn-list flex-nowrap">
                                <button @click="openEditModal(record)" class="btn btn-sm btn-outline-primary">
                                    <i class="ti ti-edit"></i> 编辑
                                </button>
                                <button @click="confirmDelete(record)" class="btn btn-sm btn-outline-danger">
                                    <i class="ti ti-trash"></i> 删除
                                </button>
                            </div>
                        </td>
                    </tr>
                    <tr v-if="loading">
                        <td colspan="9" class="text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </td>
                    </tr>
                    <tr v-else-if="records.length === 0">
                        <td colspan="9" class="text-center py-3">没有查到数据.</td>
                    </tr>
                    </tbody>
                </table>
</div>

<!-- Modals Fragment -->
<div th:fragment="modals">
    <!-- Create Stats Modal -->
    <div class="modal modal-blur fade" id="traffic-stats-createModal" tabindex="-1" role="dialog">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">添加流量统计</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label required">人员</label>
                                <select class="form-select" :class="{ 'is-invalid': validationErrors.userId }" v-model="newItem.userId">
                                    <option v-for="user in users" :key="user.id" :value="user.id">{{ user.email || user.nickName }}</option>
                                </select>
                                <div class="invalid-feedback" v-if="validationErrors.userId">{{ validationErrors.userId }}</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label required">账户ID</label>
                                <input type="number" class="form-control" :class="{ 'is-invalid': validationErrors.accountId }" v-model="newItem.accountId">
                                <div class="invalid-feedback" v-if="validationErrors.accountId">{{ validationErrors.accountId }}</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label required">开始时间</label>
                                <input type="datetime-local" class="form-control" :class="{ 'is-invalid': validationErrors.periodStart }" v-model="newItem.periodStart">
                                <div class="invalid-feedback" v-if="validationErrors.periodStart">{{ validationErrors.periodStart }}</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label required">结束时间</label>
                                <input type="datetime-local" class="form-control" :class="{ 'is-invalid': validationErrors.periodEnd }" v-model="newItem.periodEnd">
                                <div class="invalid-feedback" v-if="validationErrors.periodEnd">{{ validationErrors.periodEnd }}</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">上传流量 (字节)</label>
                                <input type="number" class="form-control" v-model="newItem.uploadBytes">
                                <small class="form-hint">{{ formatBytes(newItem.uploadBytes || 0) }}</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">下载流量 (字节)</label>
                                <input type="number" class="form-control" v-model="newItem.downloadBytes">
                                <small class="form-hint">{{ formatBytes(newItem.downloadBytes || 0) }}</small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-link link-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="button" class="btn btn-primary" @click="createItem">创建</button>
                        </div>
                    </div>
                </div>
            </div>

    <!-- Edit Stats Modal -->
    <div class="modal modal-blur fade" id="traffic-stats-editModal" tabindex="-1" role="dialog">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">编辑流量统计</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label required">人员</label>
                                <select class="form-select" :class="{ 'is-invalid': validationErrors.userId }" v-model="editedItem.userId">
                                    <option v-for="user in users" :key="user.id" :value="user.id">{{ user.email || user.nickName }}</option>
                                </select>
                                <div class="invalid-feedback" v-if="validationErrors.userId">{{ validationErrors.userId }}</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label required">账户ID</label>
                                <input type="number" class="form-control" :class="{ 'is-invalid': validationErrors.accountId }" v-model="editedItem.accountId">
                                <div class="invalid-feedback" v-if="validationErrors.accountId">{{ validationErrors.accountId }}</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label required">开始时间</label>
                                <input type="datetime-local" class="form-control" :class="{ 'is-invalid': validationErrors.periodStart }" v-model="editedItem.periodStart">
                                <div class="invalid-feedback" v-if="validationErrors.periodStart">{{ validationErrors.periodStart }}</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label required">结束时间</label>
                                <input type="datetime-local" class="form-control" :class="{ 'is-invalid': validationErrors.periodEnd }" v-model="editedItem.periodEnd">
                                <div class="invalid-feedback" v-if="validationErrors.periodEnd">{{ validationErrors.periodEnd }}</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">上传流量 (字节)</label>
                                <input type="number" class="form-control" v-model="editedItem.uploadBytes">
                                <small class="form-hint">{{ formatBytes(editedItem.uploadBytes || 0) }}</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">下载流量 (字节)</label>
                                <input type="number" class="form-control" v-model="editedItem.downloadBytes">
                                <small class="form-hint">{{ formatBytes(editedItem.downloadBytes || 0) }}</small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-link link-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="button" class="btn btn-primary" @click="updateItem">保存</button>
                        </div>
                    </div>
                </div>
    </div>
</div>