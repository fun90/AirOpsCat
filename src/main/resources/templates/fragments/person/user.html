<div th:fragment="content" class="page-body">
    <div class="container-xl">
        <!-- Use the common data table template -->
        <div th:replace="~{fragments/common/data-table :: data-table(
            '用户管理',
            '添加用户',
            'users-app',
            'users',
            ~{fragments/person/user :: filters},
            ~{fragments/person/user :: table-content},
            null,
            ~{fragments/person/user :: modals},
            'user-',
            true
        )}"></div>
    </div>
</div>

<!-- Filters Fragment -->
<th:block th:fragment="filters">
    <!-- Role filter -->
    <div class="col-auto">
        <select class="form-select" v-model="filters.role" @change="fetchRecords">
            <option value="">全部角色</option>
            <option value="ADMIN">ADMIN</option>
            <option value="PARTNER">PARTNER</option>
            <option value="VIP">VIP</option>
        </select>
    </div>
    <!-- Status filter -->
    <div class="col-auto">
        <select class="form-select" v-model="filters.status" @change="fetchRecords">
            <option value="">全部状态</option>
            <option value="active">Active</option>
            <option value="disabled">Disabled</option>
        </select>
    </div>
</th:block>

<!-- Table Content Fragment -->
<table th:fragment="table-content" class="table table-selectable card-table table-vcenter text-nowrap datatable">
    <thead>
    <tr>
        <th>ID</th>
        <th>Email</th>
        <th>Nickname</th>
        <th>Role</th>
        <th>Status</th>
        <th>Created</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    <tr v-for="user in records" :key="user.id">
        <td v-text="user.id"></td>
        <td v-text="user.email"></td>
        <td v-text="user.nickName || '-'"></td>
        <td>
            <span class="badge" :class="getRoleBadgeClass(user.role)" v-text="user.role || 'PARTNER'"></span>
        </td>
        <td>
            <span class="badge" :class="getStatusBadgeClass(user.disabled)">
                {{ user.disabled === 0 ? 'Active' : 'Disabled' }}
            </span>
        </td>
        <td v-text="formatDate(user.createTime)"></td>
        <td>
            <div class="btn-list flex-nowrap">
                <button @click="openEditModal(user)" class="btn btn-sm btn-outline-primary">
                    <i class="ti ti-edit"></i> 编辑
                </button>
                <button @click="toggleItemStatus(user, user.disabled === 0)" class="btn btn-sm"
                        :class="user.disabled === 0 ? 'btn-outline-danger' : 'btn-outline-success'">
                    <i class="ti" :class="user.disabled === 0 ? 'ti-ban' : 'ti-check'"></i>
                    {{ user.disabled === 0 ? '禁用' : '启用' }}
                </button>
                <button @click="confirmDelete(user)" class="btn btn-sm btn-outline-danger">
                    <i class="ti ti-trash"></i> 删除
                </button>
            </div>
        </td>
    </tr>
    <tr v-if="loading">
        <td colspan="7" class="text-center py-3">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </td>
    </tr>
    <tr v-else-if="records.length === 0">
        <td colspan="7" class="text-center py-3">没有查到数据.</td>
    </tr>
    </tbody>
</table>

<!-- Modals Fragment -->
<div th:fragment="modals">
    <!-- Create User Modal -->
    <div class="modal modal-blur fade" id="user-createModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加用户</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label required">邮箱</label>
                        <input type="email" class="form-control" :class="{ 'is-invalid': validationErrors.email }"
                               placeholder="user@example.com" v-model="newItem.email">
                        <div class="invalid-feedback" v-if="validationErrors.email">{{ validationErrors.email }}</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label required">密码</label>
                        <input type="password" class="form-control" :class="{ 'is-invalid': validationErrors.password }"
                               placeholder="Password" v-model="newItem.password">
                        <div class="invalid-feedback" v-if="validationErrors.password">{{ validationErrors.password }}</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">昵称</label>
                        <input type="text" class="form-control" placeholder="Nickname" v-model="newItem.nickName">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">角色</label>
                        <select class="form-select" v-model="newItem.role">
                            <option value="PARTNER">PARTNER</option>
                            <option value="ADMIN">ADMIN</option>
                            <option value="VIP">VIP</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" v-model="newItem.disabled">
                            <span class="form-check-label">禁用账户</span>
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-link link-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" @click="createItem">创建用户</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal modal-blur fade" id="user-editModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑用户</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label required">邮箱</label>
                        <input type="email" class="form-control" :class="{ 'is-invalid': validationErrors.email }"
                               placeholder="user@example.com" v-model="editedItem.email">
                        <div class="invalid-feedback" v-if="validationErrors.email">{{ validationErrors.email }}</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">密码 <span class="text-muted">(留空表示不修改)</span></label>
                        <input type="password" class="form-control" :class="{ 'is-invalid': validationErrors.password }"
                               placeholder="New password" v-model="editedItem.password">
                        <div class="invalid-feedback" v-if="validationErrors.password">{{ validationErrors.password }}</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">昵称</label>
                        <input type="text" class="form-control" placeholder="Nickname" v-model="editedItem.nickName">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">角色</label>
                        <select class="form-select" v-model="editedItem.role">
                            <option value="PARTNER">PARTNER</option>
                            <option value="ADMIN">ADMIN</option>
                            <option value="VIP">VIP</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" :checked="editedItem.disabled === 1"
                                   @change="editedItem.disabled = $event.target.checked ? 1 : 0">
                            <span class="form-check-label">禁用账户</span>
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-link link-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" @click="updateItem">保存修改</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:fragment="script" th:inline="javascript" type="module">
    import { CommonDataTable } from '/static/js/CommonDataTable.js';
    // User-specific implementation of the common data table
    const userTable = new CommonDataTable({
        data: {
            entityName: 'users',
            modalIdPrefix: 'user-',
            filters: {
                role: '',
                status: ''
            },
            newItem: {
                email: '',
                password: '',
                nickName: '',
                role: 'PARTNER',
                disabled: false
            }
        },
        methods: {
            // Initialize any additional data
            initialize() {
                // Any additional initialization needed
            },

            // Get Badge classes
            getRoleBadgeClass(role) {
                switch (role && role.toUpperCase()) {
                    case 'ADMIN': return 'text-bg-purple';
                    case 'PARTNER': return 'text-bg-indigo';
                    default: return 'text-bg-blue'; // VIP or other roles
                }
            },

            getStatusBadgeClass(disabled) {
                return disabled === 0 ? 'text-bg-success' : 'text-bg-danger';
            },

            // Form validation and preparation
            validateCreateForm() {
                let isValid = true;
                this.validationErrors = {};

                // Email validation
                if (!this.newItem.email || !this.newItem.email.trim()) {
                    this.validationErrors.email = '邮箱地址不能为空';
                    isValid = false;
                } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(this.newItem.email)) {
                    this.validationErrors.email = '请输入有效的邮箱地址';
                    isValid = false;
                }

                // Password validation
                if (!this.newItem.password || this.newItem.password.trim().length < 6) {
                    this.validationErrors.password = '密码长度至少为6个字符';
                    isValid = false;
                }

                return isValid;
            },

            validateEditForm() {
                let isValid = true;
                this.validationErrors = {};

                // Email validation
                if (!this.editedItem.email || !this.editedItem.email.trim()) {
                    this.validationErrors.email = '邮箱地址不能为空';
                    isValid = false;
                } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(this.editedItem.email)) {
                    this.validationErrors.email = '请输入有效的邮箱地址';
                    isValid = false;
                }

                // Password validation (only if provided)
                if (this.editedItem.password && this.editedItem.password.trim().length > 0 && this.editedItem.password.trim().length < 6) {
                    this.validationErrors.password = '密码长度至少为6个字符';
                    isValid = false;
                }

                return isValid;
            },

            prepareCreateData() {
                return {
                    email: this.newItem.email,
                    password: this.newItem.password,
                    nickName: this.newItem.nickName || null,
                    role: this.newItem.role,
                    disabled: this.newItem.disabled ? 1 : 0
                };
            },

            prepareUpdateData() {
                const data = {
                    email: this.editedItem.email,
                    nickName: this.editedItem.nickName || null,
                    role: this.editedItem.role,
                    disabled: this.editedItem.disabled
                };

                // Only include password if it's provided
                if (this.editedItem.password) {
                    data.password = this.editedItem.password;
                }

                return data;
            },

            resetCreateForm() {
                this.newItem = {
                    email: '',
                    password: '',
                    nickName: '',
                    role: 'PARTNER',
                    disabled: false
                };
            },

            prepareEditForm(user) {
                return {
                    id: user.id,
                    email: user.email,
                    password: '', // Empty password field
                    nickName: user.nickName || '',
                    role: user.role || 'PARTNER',
                    disabled: user.disabled
                };
            },

            // URLs for API calls
            getApiUrl() {
                return '/api/admin/users';
            },

            getToggleStatusUrl(item, action) {
                return `/api/admin/users/${item.id}/${action}`;
            }
        }
    });

    // Initialize the Vue app
    userTable.createApp('#users-app');
</script>