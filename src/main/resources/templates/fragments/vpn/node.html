<div th:fragment="content" class="page-body">
    <div class="container-xl">
        <!-- Use the common data table template -->
        <div th:replace="~{fragments/common/data-table :: data-table(
            '节点管理',
            '添加节点',
            'nodes-app',
            'nodes',
            ~{fragments/vpn/node :: filters},
            ~{fragments/vpn/node :: table-content},
            ~{fragments/vpn/node :: stats-cards},
            ~{fragments/vpn/node :: modals},
            'node-',
            true
        )}"></div>
    </div>
</div>

<!-- Stats Cards Fragment -->
<div th:fragment="stats-cards" class="card-body border-bottom">
    <div class="row">
        <div class="col-sm-6 col-lg-3">
            <div class="card card-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <span class="bg-primary text-white avatar">
                                <i class="ti ti-router"></i>
                            </span>
                        </div>
                        <div class="col">
                            <div class="font-weight-medium">
                                总节点数
                            </div>
                            <div class="text-muted">
                                {{ stats.total || 0 }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-lg-3">
            <div class="card card-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <span class="bg-green text-white avatar">
                                <i class="ti ti-circle-check"></i>
                            </span>
                        </div>
                        <div class="col">
                            <div class="font-weight-medium">
                                活跃节点
                            </div>
                            <div class="text-muted">
                                {{ stats.active || 0 }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-lg-3">
            <div class="card card-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <span class="bg-blue text-white avatar">
                                <i class="ti ti-arrow-bar-to-up"></i>
                            </span>
                        </div>
                        <div class="col">
                            <div class="font-weight-medium">
                                代理节点
                            </div>
                            <div class="text-muted">
                                {{ stats.proxy || 0 }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-lg-3">
            <div class="card card-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <span class="bg-purple text-white avatar">
                                <i class="ti ti-arrow-bar-down"></i>
                            </span>
                        </div>
                        <div class="col">
                            <div class="font-weight-medium">
                                落地节点
                            </div>
                            <div class="text-muted">
                                {{ stats.landing || 0 }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filters Fragment -->
<th:block th:fragment="filters">
    <!-- Server filter -->
    <div class="col-auto">
        <select class="form-select" v-model="filters.serverId" @change="fetchRecords">
            <option value="">全部服务器</option>
            <option v-for="server in servers" :key="server.id" :value="server.id">{{ server.name }}</option>
        </select>
    </div>
    <!-- Type filter -->
    <div class="col-auto">
        <select class="form-select" v-model="filters.type" @change="fetchRecords">
            <option value="">全部类型</option>
            <option v-for="type in nodeTypes" :key="type.value" :value="type.value">{{ type.label }}</option>
        </select>
    </div>
    <!-- Status filter -->
    <div class="col-auto">
        <select class="form-select" v-model="filters.status" @change="fetchRecords">
            <option value="">全部状态</option>
            <option value="active">已启用</option>
            <option value="disabled">已禁用</option>
        </select>
    </div>
</th:block>

<!-- Table Content Fragment -->
<div th:fragment="table-content">
    <table class="table table-vcenter card-table">
        <thead>
        <tr>
            <th>ID</th>
            <th>名称</th>
            <th>服务器</th>
            <th>端口</th>
            <th>类型</th>
            <th>协议</th>
            <th>级别</th>
            <th>状态</th>
            <th>操作</th>
        </tr>
        </thead>
        <tbody>
        <tr v-for="node in records" :key="node.id">
            <td v-text="node.id"></td>
            <td>
                <div class="d-flex flex-column">
                    <span v-text="node.name || '-'"></span>
                    <span v-if="node.remark" class="text-muted small">{{ node.remark }}</span>
                </div>
            </td>
            <td>
                <div class="d-flex flex-column">
                    <span v-text="node.serverIp"></span>
                    <span v-if="node.serverHost" class="text-muted small">{{ node.serverHost }}</span>
                </div>
            </td>
            <td v-text="node.port"></td>
            <td>
                <span class="badge" :class="getTypeBadgeClass(node.type)">
                    {{ node.typeDescription }}
                </span>
            </td>
            <td>
                <span class="badge text-bg-info">
                    {{ node.protocol }}
                </span>
            </td>
            <td v-text="node.level || '-'"></td>
            <td>
                <span class="badge" :class="getStatusBadgeClass(node.disabled)">
                    {{ node.statusDescription }}
                </span>
            </td>
            <td>
                <div class="btn-list flex-nowrap">
                    <div class="dropdown">
                        <button class="btn btn-sm dropdown-toggle align-text-top" data-bs-toggle="dropdown">
                            操作
                        </button>
                        <div class="dropdown-menu dropdown-menu-end">
                            <a class="dropdown-item" href="#" @click.prevent="openEditModal(node)">
                                <i class="ti ti-edit"></i> 编辑
                            </a>
                            <a class="dropdown-item" href="#" @click.prevent="viewNodeConfig(node)">
                                <i class="ti ti-code"></i> 查看配置
                            </a>
                            <a v-if="node.disabled === 1" class="dropdown-item" href="#" @click.prevent="toggleItemStatus(node, false)">
                                <i class="ti ti-check"></i> 启用
                            </a>
                            <a v-else class="dropdown-item" href="#" @click.prevent="toggleItemStatus(node, true)">
                                <i class="ti ti-ban"></i> 禁用
                            </a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="#" @click.prevent="copyNode(node)">
                                <i class="ti ti-copy"></i> 复制
                            </a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item text-danger" href="#" @click.prevent="confirmDelete(node)">
                                <i class="ti ti-trash"></i> 删除
                            </a>
                        </div>
                    </div>
                </div>
            </td>
        </tr>
        <tr v-if="loading">
            <td colspan="9" class="text-center py-3">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </td>
        </tr>
        <tr v-else-if="records.length === 0">
            <td colspan="9" class="text-center py-3">没有查到数据.</td>
        </tr>
        </tbody>
    </table>
</div>

<!-- Modals Fragment -->
<div th:fragment="modals">
    <!-- Create Node Modal -->
    <div class="modal modal-blur fade" id="node-createModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加节点</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" data-bs-toggle="tabs">
                        <li class="nav-item">
                            <a href="#tabs-basic" class="nav-link active" data-bs-toggle="tab">基本信息</a>
                        </li>
                        <li class="nav-item">
                            <a href="#tabs-inbound" class="nav-link" data-bs-toggle="tab">入站配置</a>
                        </li>
                        <li class="nav-item">
                            <a href="#tabs-outbound" class="nav-link" data-bs-toggle="tab">出站配置</a>
                        </li>
                        <li class="nav-item">
                            <a href="#tabs-rule" class="nav-link" data-bs-toggle="tab">规则配置</a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane active show" id="tabs-basic">
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">节点名称</label>
                                        <input type="text" class="form-control" v-model="newItem.name">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label required">节点类型</label>
                                        <select class="form-select" :class="{ 'is-invalid': validationErrors.type }" v-model="newItem.type">
                                            <option v-for="type in nodeTypes" :key="type.value" :value="type.value">{{ type.label }}</option>
                                        </select>
                                        <div class="invalid-feedback" v-if="validationErrors.type">{{ validationErrors.type }}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label required">服务器</label>
                                        <select class="form-select" :class="{ 'is-invalid': validationErrors.serverId }" v-model="newItem.serverId" @change="onServerChange">
                                            <option v-for="server in servers" :key="server.id" :value="server.id">{{ server.name }}</option>
                                        </select>
                                        <div class="invalid-feedback" v-if="validationErrors.serverId">{{ validationErrors.serverId }}</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label required">端口</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" :class="{ 'is-invalid': validationErrors.port }" v-model="newItem.port" min="1" max="65535">
                                            <button class="btn" type="button" @click="getAvailablePort">自动获取</button>
                                        </div>
                                        <div class="invalid-feedback" v-if="validationErrors.port">{{ validationErrors.port }}</div>
                                        <small class="form-hint" v-if="portCheckMessage">{{ portCheckMessage }}</small>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">级别</label>
                                        <input type="number" class="form-control" v-model="newItem.level" min="0">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">备注</label>
                                <textarea class="form-control" v-model="newItem.remark" rows="2"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" v-model="newItem.disabled">
                                    <span class="form-check-label">禁用节点</span>
                                </label>
                            </div>
                        </div>
                        <div class="tab-pane" id="tabs-inbound">
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label required">协议</label>
                                        <select class="form-select" :class="{ 'is-invalid': validationErrors.protocol }" v-model="newNodeInbound.protocol" @change="onProtocolChange">
                                            <option v-for="protocol in protocolTypes" :key="protocol.value" :value="protocol.value">{{ protocol.label }}</option>
                                        </select>
                                        <div class="invalid-feedback" v-if="validationErrors.protocol">{{ validationErrors.protocol }}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 根据不同的协议类型显示不同的参数表单 -->
                            <div v-if="newNodeInbound.protocol === 'VLESS'">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">加密方式</label>
                                            <select class="form-select" v-model="newNodeInbound.encryption">
                                                <option value="none">none</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">UUID</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" v-model="newNodeInbound.uuid">
                                                <button class="btn" type="button" @click="generateUuid">生成</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Shadowsocks Protocol Options -->
                            <div v-else-if="newNodeInbound.protocol === 'Shadowsocks'">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">加密方式</label>
                                            <select class="form-select" v-model="newNodeInbound.method">
                                                <option value="aes-256-gcm">aes-256-gcm</option>
                                                <option value="chacha20-poly1305">chacha20-poly1305</option>
                                                <option value="2022-blake3-aes-256-gcm">2022-blake3-aes-256-gcm</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">密码</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" v-model="newNodeInbound.password">
                                                <button class="btn" type="button" @click="generateRandomPassword">生成</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Socks Protocol Options -->
                            <div v-else-if="newNodeInbound.protocol === 'Socks'">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">用户名</label>
                                            <input type="text" class="form-control" v-model="newNodeInbound.username">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">密码</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" v-model="newNodeInbound.password">
                                                <button class="btn" type="button" @click="generateRandomPassword">生成</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Hysteria2 Protocol Options -->
                            <div v-else-if="newNodeInbound.protocol === 'Hysteria2'">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">密码</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" v-model="newNodeInbound.password">
                                                <button class="btn" type="button" @click="generateRandomPassword">生成</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">上行带宽 (Mbps)</label>
                                            <input type="number" class="form-control" v-model="newNodeInbound.up_mbps" min="1">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">下行带宽 (Mbps)</label>
                                            <input type="number" class="form-control" v-model="newNodeInbound.down_mbps" min="1">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ShadowTLS Protocol Options -->
                            <div v-else-if="newNodeInbound.protocol === 'ShadowTLS'">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">版本</label>
                                            <select class="form-select" v-model="newNodeInbound.version">
                                                <option :value="1">1</option>
                                                <option :value="2">2</option>
                                                <option :value="3">3</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">密码</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" v-model="newNodeInbound.password">
                                                <button class="btn" type="button" @click="generateRandomPassword">生成</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row mt-3">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label class="form-label">高级配置 (JSON)</label>
                                        <textarea class="form-control font-monospace" v-model="newNodeInboundJson" rows="5" placeholder='{"key": "value"}'></textarea>
                                        <small class="form-hint">可以添加协议特有的其他配置参数</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane" id="tabs-outbound">
                            <div class="row mt-3">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label class="form-label">出站配置 (JSON)</label>
                                        <textarea class="form-control font-monospace" v-model="newNodeOutboundJson" rows="10" placeholder='{"key": "value"}'></textarea>
                                        <small class="form-hint">用于配置节点的出站连接</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane" id="tabs-rule">
                            <div class="row mt-3">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label class="form-label">规则配置 (JSON)</label>
                                        <textarea class="form-control font-monospace" v-model="newNodeRuleJson" rows="10" placeholder='{"key": "value"}'></textarea>
                                        <small class="form-hint">用于配置节点的路由规则</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-link link-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" @click="createItem">创建</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Node Modal -->
    <div class="modal modal-blur fade" id="node-editModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑节点</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" data-bs-toggle="tabs">
                        <li class="nav-item">
                            <a href="#edit-tabs-basic" class="nav-link active" data-bs-toggle="tab">基本信息</a>
                        </li>
                        <li class="nav-item">
                            <a href="#edit-tabs-inbound" class="nav-link" data-bs-toggle="tab">入站配置</a>
                        </li>
                        <li class="nav-item">
                            <a href="#edit-tabs-outbound" class="nav-link" data-bs-toggle="tab">出站配置</a>
                        </li>
                        <li class="nav-item">
                            <a href="#edit-tabs-rule" class="nav-link" data-bs-toggle="tab">规则配置</a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane active show" id="edit-tabs-basic">
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">节点名称</label>
                                        <input type="text" class="form-control" v-model="editedItem.name">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label required">节点类型</label>
                                        <select class="form-select" :class="{ 'is-invalid': validationErrors.type }" v-model="editedItem.type">
                                            <option v-for="type in nodeTypes" :key="type.value" :value="type.value">{{ type.label }}</option>
                                        </select>
                                        <div class="invalid-feedback" v-if="validationErrors.type">{{ validationErrors.type }}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label required">服务器</label>
                                        <select class="form-select" :class="{ 'is-invalid': validationErrors.serverId }" v-model="editedItem.serverId" @change="onEditServerChange">
                                            <option v-for="server in servers" :key="server.id" :value="server.id">{{ server.name }}</option>
                                        </select>
                                        <div class="invalid-feedback" v-if="validationErrors.serverId">{{ validationErrors.serverId }}</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label required">端口</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" :class="{ 'is-invalid': validationErrors.port }" v-model="editedItem.port" min="1" max="65535">
                                            <button class="btn" type="button" @click="getEditAvailablePort">自动获取</button>
                                        </div>
                                        <div class="invalid-feedback" v-if="validationErrors.port">{{ validationErrors.port }}</div>
                                        <small class="form-hint" v-if="editPortCheckMessage">{{ editPortCheckMessage }}</small>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">级别</label>
                                        <input type="number" class="form-control" v-model="editedItem.level" min="0">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">备注</label>
                                <textarea class="form-control" v-model="editedItem.remark" rows="2"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" :checked="editedItem.disabled === 1" @change="editedItem.disabled = $event.target.checked ? 1 : 0">
                                    <span class="form-check-label">禁用节点</span>
                                </label>
                            </div>
                        </div>
                        <div class="tab-pane" id="edit-tabs-inbound">
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label required">协议</label>
                                        <select class="form-select" :class="{ 'is-invalid': validationErrors.protocol }" v-model="editedNodeInbound.protocol" @change="onEditProtocolChange">
                                            <option v-for="protocol in protocolTypes" :key="protocol.value" :value="protocol.value">{{ protocol.label }}</option>
                                        </select>
                                        <div class="invalid-feedback" v-if="validationErrors.protocol">{{ validationErrors.protocol }}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 各种协议的编辑表单与新建类似，根据需要可以重复上面的条件表单 -->

                            <div class="row mt-3">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label class="form-label">高级配置 (JSON)</label>
                                        <textarea class="form-control font-monospace" v-model="editedNodeInboundJson" rows="5" placeholder='{"key": "value"}'></textarea>
                                        <small class="form-hint">可以添加协议特有的其他配置参数</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane" id="edit-tabs-outbound">
                            <div class="row mt-3">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label class="form-label">出站配置 (JSON)</label>
                                        <textarea class="form-control font-monospace" v-model="editedNodeOutboundJson" rows="10" placeholder='{"key": "value"}'></textarea>
                                        <small class="form-hint">用于配置节点的出站连接</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane" id="edit-tabs-rule">
                            <div class="row mt-3">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label class="form-label">规则配置 (JSON)</label>
                                        <textarea class="form-control font-monospace" v-model="editedNodeRuleJson" rows="10" placeholder='{"key": "value"}'></textarea>
                                        <small class="form-hint">用于配置节点的路由规则</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-link link-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" @click="updateItem">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Config Modal -->
    <div class="modal modal-blur fade" id="viewConfigModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">节点配置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" data-bs-toggle="tabs">
                        <li class="nav-item">
                            <a href="#view-tabs-inbound" class="nav-link active" data-bs-toggle="tab">入站配置</a>
                        </li>
                        <li class="nav-item">
                            <a href="#view-tabs-outbound" class="nav-link" data-bs-toggle="tab">出站配置</a>
                        </li>
                        <li class="nav-item">
                            <a href="#view-tabs-rule" class="nav-link" data-bs-toggle="tab">规则配置</a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane active show" id="view-tabs-inbound">
                            <div class="row mt-3">
                                <div class="col-md-12">
                                    <pre class="bg-light p-3 rounded">{{ selectedNodeInboundFormatted }}</pre>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane" id="view-tabs-outbound">
                            <div class="row mt-3">
                                <div class="col-md-12">
                                    <pre class="bg-light p-3 rounded">{{ selectedNodeOutboundFormatted }}</pre>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane" id="view-tabs-rule">
                            <div class="row mt-3">
                                <div class="col-md-12">
                                    <pre class="bg-light p-3 rounded">{{ selectedNodeRuleFormatted }}</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-link link-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:fragment="script" th:inline="javascript">
    // Node-specific implementation of the common data table
    const nodeTable = new CommonDataTable({
        data: {
            entityName: 'nodes',
            modalIdPrefix: 'node-',
            filters: {
                serverId: '',
                type: '',
                status: ''
            },
            servers: [],
            nodeTypes: [],
            protocolTypes: [],
            stats: {
                total: 0,
                active: 0,
                proxy: 0,
                landing: 0
            },
            // Form data
            newItem: {
                serverId: '',
                port: null,
                type: 0, // 默认为代理节点
                level: 0,
                disabled: false,
                name: '',
                remark: '',
                inbound: null,
                outbound: null,
                rule: null
            },
            // Additional data for node management
            portCheckMessage: '',
            editPortCheckMessage: '',
            newNodeInbound: {
                protocol: 'VLESS'
            },
            newNodeInboundJson: '',
            newNodeOutboundJson: '',
            newNodeRuleJson: '',
            editedNodeInbound: {
                protocol: 'VLESS'
            },
            editedNodeInboundJson: '',
            editedNodeOutboundJson: '',
            editedNodeRuleJson: '',
            // For viewing configs
            viewConfigModal: null,
            selectedNode: null
        },
        computed: {
            selectedNodeInboundFormatted() {
                if (!this.selectedNode || !this.selectedNode.inbound) {
                    return "{}";
                }

                try {
                    return JSON.stringify(this.selectedNode.inbound, null, 2);
                } catch (e) {
                    return "{}";
                }
            },

            selectedNodeOutboundFormatted() {
                if (!this.selectedNode || !this.selectedNode.outbound) {
                    return "{}";
                }

                try {
                    return JSON.stringify(this.selectedNode.outbound, null, 2);
                } catch (e) {
                    return "{}";
                }
            },

            selectedNodeRuleFormatted() {
                if (!this.selectedNode || !this.selectedNode.rule) {
                    return "{}";
                }

                try {
                    return JSON.stringify(this.selectedNode.rule, null, 2);
                } catch (e) {
                    return "{}";
                }
            }
        },
        methods: {
            // Initialize additional data
            initialize() {
                this.fetchServers();
                this.fetchNodeTypes();
                this.fetchProtocolTypes();
            },

            // Fetch data methods
            fetchServers() {
                fetch('/api/admin/nodes/servers')
                    .then(response => response.json())
                    .then(data => {
                        this.servers = data;

                        // 如果是第一次加载且当前没有选中服务器，选择第一个服务器
                        if (this.servers.length > 0 && !this.newItem.serverId) {
                            this.newItem.serverId = this.servers[0].id;
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching servers:', error);
                    });
            },

            fetchNodeTypes() {
                fetch('/api/admin/nodes/types')
                    .then(response => response.json())
                    .then(data => {
                        this.nodeTypes = data;
                    })
                    .catch(error => {
                        console.error('Error fetching node types:', error);
                    });
            },

            fetchProtocolTypes() {
                fetch('/api/admin/nodes/protocols')
                    .then(response => response.json())
                    .then(data => {
                        this.protocolTypes = data;
                    })
                    .catch(error => {
                        console.error('Error fetching protocol types:', error);
                    });
            },

            // Get Badge classes
            getTypeBadgeClass(type) {
                switch (type) {
                    case 0: return 'text-bg-blue';
                    case 1: return 'text-bg-purple';
                    default: return 'text-bg-secondary';
                }
            },

            getStatusBadgeClass(disabled) {
                return disabled === 0 ? 'text-bg-success' : 'text-bg-danger';
            },

            // Server and port related methods
            onServerChange() {
                this.checkPortAvailability();
            },

            onEditServerChange() {
                this.checkEditPortAvailability();
            },

            checkPortAvailability() {
                if (!this.newItem.serverId || !this.newItem.port) {
                    this.portCheckMessage = '';
                    return;
                }

                fetch(`/api/admin/nodes/check-port?serverId=${this.newItem.serverId}&port=${this.newItem.port}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.available) {
                            this.portCheckMessage = '端口可用';
                        } else {
                            this.portCheckMessage = '端口已被占用';
                        }
                    })
                    .catch(error => {
                        console.error('Error checking port:', error);
                        this.portCheckMessage = '检查端口失败';
                    });
            },

            checkEditPortAvailability() {
                if (!this.editedItem.serverId || !this.editedItem.port || !this.editedItem.id) {
                    this.editPortCheckMessage = '';
                    return;
                }

                fetch(`/api/admin/nodes/check-port?serverId=${this.editedItem.serverId}&port=${this.editedItem.port}&nodeId=${this.editedItem.id}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.available) {
                            this.editPortCheckMessage = '端口可用';
                        } else {
                            this.editPortCheckMessage = '端口已被占用';
                        }
                    })
                    .catch(error => {
                        console.error('Error checking port:', error);
                        this.editPortCheckMessage = '检查端口失败';
                    });
            },

            getAvailablePort() {
                if (!this.newItem.serverId) {
                    ToastUtils.show('Warning', '请先选择服务器', 'warning');
                    return;
                }

                fetch(`/api/admin/nodes/available-port?serverId=${this.newItem.serverId}`)
                    .then(response => response.json())
                    .then(data => {
                        this.newItem.port = data.port;
                        this.checkPortAvailability();
                    })
                    .catch(error => {
                        console.error('Error getting available port:', error);
                        ToastUtils.show('Error', '获取可用端口失败', 'danger');
                    });
            },

            getEditAvailablePort() {
                if (!this.editedItem.serverId) {
                    ToastUtils.show('Warning', '请先选择服务器', 'warning');
                    return;
                }

                fetch(`/api/admin/nodes/available-port?serverId=${this.editedItem.serverId}`)
                    .then(response => response.json())
                    .then(data => {
                        this.editedItem.port = data.port;
                        this.checkEditPortAvailability();
                    })
                    .catch(error => {
                        console.error('Error getting available port:', error);
                        ToastUtils.show('Error', '获取可用端口失败', 'danger');
                    });
            },

            // Protocol related methods
            onProtocolChange() {
                // 获取默认配置
                fetch(`/api/admin/nodes/default-inbound?protocol=${this.newNodeInbound.protocol}`)
                    .then(response => response.json())
                    .then(data => {
                        this.newNodeInbound = data;
                        this.newNodeInboundJson = JSON.stringify(data, null, 2);
                    })
                    .catch(error => {
                        console.error('Error getting default inbound config:', error);
                    });
            },

            onEditProtocolChange() {
                // 获取默认配置
                fetch(`/api/admin/nodes/default-inbound?protocol=${this.editedNodeInbound.protocol}`)
                    .then(response => response.json())
                    .then(data => {
                        this.editedNodeInbound = data;
                        this.editedNodeInboundJson = JSON.stringify(data, null, 2);
                    })
                    .catch(error => {
                        console.error('Error getting default inbound config:', error);
                    });
            },

            // Generator methods
            generateUuid() {
                this.newNodeInbound.uuid = this.uuidv4();
            },

            generateRandomPassword() {
                const password = this.generateRandomString(16);

                if (this.newNodeInbound.password !== undefined) {
                    this.newNodeInbound.password = password;
                }

                if (this.editedNodeInbound.password !== undefined) {
                    this.editedNodeInbound.password = password;
                }
            },

            // View configuration
            viewNodeConfig(node) {
                this.selectedNode = node;
                this.viewConfigModal = new bootstrap.Modal(document.getElementById('viewConfigModal'));
                this.viewConfigModal.show();
            },

            // Form validation and preparation
            validateCreateForm() {
                let isValid = true;
                this.validationErrors = {};

                // Check server
                if (!this.newItem.serverId) {
                    this.validationErrors.serverId = '请选择服务器';
                    isValid = false;
                }

                // Check port
                if (!this.newItem.port) {
                    this.validationErrors.port = '请输入端口';
                    isValid = false;
                } else if (this.newItem.port < 1 || this.newItem.port > 65535) {
                    this.validationErrors.port = '端口范围应为1-65535';
                    isValid = false;
                }

                // Check node type
                if (this.newItem.type === null || this.newItem.type === undefined) {
                    this.validationErrors.type = '请选择节点类型';
                    isValid = false;
                }

                return isValid;
            },

            validateEditForm() {
                let isValid = true;
                this.validationErrors = {};

                // Similar validation as create form
                if (!this.editedItem.serverId) {
                    this.validationErrors.serverId = '请选择服务器';
                    isValid = false;
                }

                if (!this.editedItem.port) {
                    this.validationErrors.port = '请输入端口';
                    isValid = false;
                } else if (this.editedItem.port < 1 || this.editedItem.port > 65535) {
                    this.validationErrors.port = '端口范围应为1-65535';
                    isValid = false;
                }

                if (this.editedItem.type === null || this.editedItem.type === undefined) {
                    this.validationErrors.type = '请选择节点类型';
                    isValid = false;
                }

                return isValid;
            },

            prepareCreateData() {
                try {
                    // Merge inbound config with JSON
                    let inboundConfig = this.newNodeInbound;
                    if (this.newNodeInboundJson) {
                        const jsonData = JSON.parse(this.newNodeInboundJson);
                        inboundConfig = { ...inboundConfig, ...jsonData };
                    }

                    // Process outbound and rule configs
                    let outboundConfig = null;
                    let ruleConfig = null;

                    if (this.newNodeOutboundJson && this.newNodeOutboundJson.trim() !== '{}') {
                        outboundConfig = JSON.parse(this.newNodeOutboundJson);
                    }

                    if (this.newNodeRuleJson && this.newNodeRuleJson.trim() !== '{}') {
                        ruleConfig = JSON.parse(this.newNodeRuleJson);
                    }

                    // Prepare data for API
                    return {
                        serverId: this.newItem.serverId,
                        port: this.newItem.port,
                        type: this.newItem.type,
                        level: this.newItem.level || 0,
                        disabled: this.newItem.disabled ? 1 : 0,
                        name: this.newItem.name || null,
                        remark: this.newItem.remark || null,
                        inbound: inboundConfig,
                        outbound: outboundConfig,
                        rule: ruleConfig
                    };
                } catch (e) {
                    console.error('Error parsing JSON:', e);
                    ToastUtils.show('Error', 'JSON格式错误: ' + e.message, 'danger');
                    throw e;
                }
            },

            prepareUpdateData() {
                try {
                    // Similar to create data preparation
                    let inboundConfig = this.editedNodeInbound;
                    if (this.editedNodeInboundJson) {
                        const jsonData = JSON.parse(this.editedNodeInboundJson);
                        inboundConfig = { ...inboundConfig, ...jsonData };
                    }

                    let outboundConfig = null;
                    let ruleConfig = null;

                    if (this.editedNodeOutboundJson && this.editedNodeOutboundJson.trim() !== '{}') {
                        outboundConfig = JSON.parse(this.editedNodeOutboundJson);
                    }

                    if (this.editedNodeRuleJson && this.editedNodeRuleJson.trim() !== '{}') {
                        ruleConfig = JSON.parse(this.editedNodeRuleJson);
                    }

                    return {
                        id: this.editedItem.id,
                        serverId: this.editedItem.serverId,
                        port: this.editedItem.port,
                        type: this.editedItem.type,
                        level: this.editedItem.level || 0,
                        disabled: this.editedItem.disabled,
                        name: this.editedItem.name || null,
                        remark: this.editedItem.remark || null,
                        inbound: inboundConfig,
                        outbound: outboundConfig,
                        rule: ruleConfig
                    };
                } catch (e) {
                    console.error('Error parsing JSON:', e);
                    ToastUtils.show('Error', 'JSON格式错误: ' + e.message, 'danger');
                    throw e;
                }
            },

            resetCreateForm() {
                this.newItem = {
                    serverId: this.servers.length > 0 ? this.servers[0].id : '',
                    port: null,
                    type: 0,
                    level: 0,
                    disabled: false,
                    name: '',
                    remark: '',
                    inbound: null,
                    outbound: null,
                    rule: null
                };

                // Reset inbound data
                this.newNodeInbound = {
                    protocol: 'VLESS'
                };
                this.onProtocolChange(); // Get default configuration

                this.newNodeOutboundJson = '{}';
                this.newNodeRuleJson = '{}';
                this.portCheckMessage = '';
            },

            prepareEditForm(node) {
                // Format inbound, outbound and rule data
                this.editedNodeInbound = node.inbound || { protocol: 'VLESS' };
                this.editedNodeInboundJson = JSON.stringify(node.inbound || {}, null, 2);
                this.editedNodeOutboundJson = JSON.stringify(node.outbound || {}, null, 2);
                this.editedNodeRuleJson = JSON.stringify(node.rule || {}, null, 2);

                this.editPortCheckMessage = '';

                // Return basic item data
                return {
                    id: node.id,
                    serverId: node.serverId,
                    port: node.port,
                    type: node.type,
                    level: node.level || 0,
                    disabled: node.disabled,
                    name: node.name || '',
                    remark: node.remark || '',
                    inbound: node.inbound,
                    outbound: node.outbound,
                    rule: node.rule
                };
            },

            // URLs for API calls
            getApiUrl() {
                return '/api/admin/nodes';
            },

            getToggleStatusUrl(item, enabled) {
                return `/api/admin/nodes/${item.id}/${enabled ? 'enable' : 'disable'}`;
            },

            copyNode(node) {
                if (!node.id) return;

                // Show loading toast
                ToastUtils.show('Info', '正在复制节点...', 'info');

                fetch(`/api/admin/nodes/${node.id}/copy`, {
                    method: 'POST'
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('复制节点失败');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Refresh the node list
                        this.fetchRecords();
                        ToastUtils.show('Success', '复制节点成功', 'success');
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        ToastUtils.show('Error', '复制节点失败', 'danger');
                    });
            }
        }
    });

    // Initialize the Vue app
    nodeTable.createApp('#nodes-app');
</script>