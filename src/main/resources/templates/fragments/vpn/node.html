<div th:fragment="content" class="page-body">
    <div class="container-xl">
        <div class="card" id="nodes-app" @vue:mounted="mounted">
            <div class="card-header">
                <h3 class="card-title">节点管理</h3>
                <div class="card-actions">
                    <div class="row g-2">
                        <div class="col">
                            <input type="text" class="form-control" placeholder="搜索节点名称、备注、服务器..." v-model="searchQuery" @input="searchDebounced">
                        </div>
                        <div class="col-auto">
                            <select class="form-select" v-model="filterServerId" @change="fetchNodes">
                                <option value="">全部服务器</option>
                                <option v-for="server in servers" :key="server.id" :value="server.id">{{ server.name }}</option>
                            </select>
                        </div>
                        <div class="col-auto">
                            <select class="form-select" v-model="filterType" @change="fetchNodes">
                                <option value="">全部类型</option>
                                <option v-for="type in nodeTypes" :key="type.value" :value="type.value">{{ type.label }}</option>
                            </select>
                        </div>
                        <div class="col-auto">
                            <select class="form-select" v-model="filterStatus" @change="fetchNodes">
                                <option value="">全部状态</option>
                                <option value="active">已启用</option>
                                <option value="disabled">已禁用</option>
                            </select>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-primary" @click="openCreateNodeModal">
                                <i class="ti ti-plus"></i> 添加节点
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 节点统计卡片 -->
            <div class="card-body border-bottom">
                <div class="row">
                    <div class="col-sm-6 col-lg-3">
                        <div class="card card-sm">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <span class="bg-primary text-white avatar">
                                            <i class="ti ti-router"></i>
                                        </span>
                                    </div>
                                    <div class="col">
                                        <div class="font-weight-medium">
                                            总节点数
                                        </div>
                                        <div class="text-muted">
                                            {{ stats.total || 0 }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-3">
                        <div class="card card-sm">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <span class="bg-green text-white avatar">
                                            <i class="ti ti-circle-check"></i>
                                        </span>
                                    </div>
                                    <div class="col">
                                        <div class="font-weight-medium">
                                            活跃节点
                                        </div>
                                        <div class="text-muted">
                                            {{ stats.active || 0 }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-3">
                        <div class="card card-sm">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <span class="bg-blue text-white avatar">
                                            <i class="ti ti-arrow-bar-to-up"></i>
                                        </span>
                                    </div>
                                    <div class="col">
                                        <div class="font-weight-medium">
                                            代理节点
                                        </div>
                                        <div class="text-muted">
                                            {{ stats.proxy || 0 }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-3">
                        <div class="card card-sm">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <span class="bg-purple text-white avatar">
                                            <i class="ti ti-arrow-bar-down"></i>
                                        </span>
                                    </div>
                                    <div class="col">
                                        <div class="font-weight-medium">
                                            落地节点
                                        </div>
                                        <div class="text-muted">
                                            {{ stats.landing || 0 }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-body p-0">
                <table class="table table-vcenter card-table">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>名称</th>
                        <th>服务器</th>
                        <th>端口</th>
                        <th>类型</th>
                        <th>协议</th>
                        <th>级别</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr v-for="node in nodes" :key="node.id">
                        <td v-text="node.id"></td>
                        <td>
                            <div class="d-flex flex-column">
                                <span v-text="node.name || '-'"></span>
                                <span v-if="node.remark" class="text-muted small">{{ node.remark }}</span>
                            </div>
                        </td>
                        <td>
                            <div class="d-flex flex-column">
                                <span v-text="node.serverIp"></span>
                                <span v-if="node.serverHost" class="text-muted small">{{ node.serverHost }}</span>
                            </div>
                        </td>
                        <td v-text="node.port"></td>
                        <td>
                            <span class="badge" :class="getTypeBadgeClass(node.type)">
                                {{ node.typeDesc }}
                            </span>
                        </td>
                        <td>
                            <span class="badge text-bg-info">
                                {{ node.protocol }}
                            </span>
                        </td>
                        <td v-text="node.level || '-'"></td>
                        <td>
                            <span class="badge" :class="getStatusBadgeClass(node.disabled)">
                                {{ node.statusDescription }}
                            </span>
                        </td>
                        <td>
                            <div class="btn-list flex-nowrap">
                                <div class="dropdown">
                                    <button class="btn btn-sm dropdown-toggle align-text-top" data-bs-toggle="dropdown">
                                        操作
                                    </button>
                                    <div class="dropdown-menu dropdown-menu-end">
                                        <a class="dropdown-item" href="#" @click.prevent="openEditNodeModal(node)">
                                            <i class="ti ti-edit"></i> 编辑
                                        </a>
                                        <a class="dropdown-item" href="#" @click.prevent="viewNodeConfig(node)">
                                            <i class="ti ti-code"></i> 查看配置
                                        </a>
                                        <a v-if="node.disabled === 1" class="dropdown-item" href="#" @click.prevent="toggleNodeStatus(node, false)">
                                            <i class="ti ti-check"></i> 启用
                                        </a>
                                        <a v-else class="dropdown-item" href="#" @click.prevent="toggleNodeStatus(node, true)">
                                            <i class="ti ti-ban"></i> 禁用
                                        </a>
                                        <div class="dropdown-divider"></div>
                                        <a class="dropdown-item text-danger" href="#" @click.prevent="confirmDelete(node)">
                                            <i class="ti ti-trash"></i> 删除
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr v-if="loading">
                        <td colspan="9" class="text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </td>
                    </tr>
                    <tr v-else-if="nodes.length === 0">
                        <td colspan="9" class="text-center py-3">没有查到数据.</td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <!-- 分页 -->
            <div class="card-footer d-flex align-items-center">
                <div class="d-flex">
                    <div class="text-muted">
                        每页显示
                        <div class="mx-2 d-inline-block">
                            <select class="form-select form-select-sm" v-model="pageSize" @change="changePageSize">
                                <option value="5">5</option>
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                        条记录
                    </div>
                    <div class="ms-auto text-muted" v-if="totalItems > 0">
                        显示
                        <span class="text-body strong">{{ startIndex }}</span> 到
                        <span class="text-body strong">{{ endIndex }}</span> 条，共
                        <span class="text-body strong">{{ totalItems }}</span> 条
                    </div>
                </div>
                <ul class="pagination m-0 ms-auto" v-if="totalPages > 0">
                    <li class="page-item" :class="{ disabled: currentPage === 1 }">
                        <a class="page-link" href="#" @click.prevent="prevPage">
                            <i class="ti ti-chevron-left"></i> 上一页
                        </a>
                    </li>
                    <!-- Display page numbers dynamically -->
                    <li class="page-item" v-for="page in paginationPages" :key="page"
                        :class="{ active: page === currentPage }">
                        <a class="page-link" href="#" @click.prevent="goToPage(page)">{{ page }}</a>
                    </li>
                    <li class="page-item" :class="{ disabled: currentPage === totalPages }">
                        <a class="page-link" href="#" @click.prevent="nextPage">
                            下一页 <i class="ti ti-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Delete Confirmation Modal -->
            <div class="modal modal-blur fade" id="deleteModal" tabindex="-1" role="dialog">
                <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-body">
                            <div class="modal-title">确定删除吗?</div>
                            <div>若确认删除，数据将无法恢复</div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-link link-secondary me-auto" data-bs-dismiss="modal">取消</button>
                            <button type="button" class="btn btn-danger" @click="deleteNode">确认</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Create Node Modal -->
            <div class="modal modal-blur fade" id="createNodeModal" tabindex="-1" role="dialog">
                <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">添加节点</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <ul class="nav nav-tabs" data-bs-toggle="tabs">
                                <li class="nav-item">
                                    <a href="#tabs-basic" class="nav-link active" data-bs-toggle="tab">基本信息</a>
                                </li>
                                <li class="nav-item">
                                    <a href="#tabs-inbound" class="nav-link" data-bs-toggle="tab">入站配置</a>
                                </li>
                                <li class="nav-item">
                                    <a href="#tabs-outbound" class="nav-link" data-bs-toggle="tab">出站配置</a>
                                </li>
                                <li class="nav-item">
                                    <a href="#tabs-rule" class="nav-link" data-bs-toggle="tab">规则配置</a>
                                </li>
                            </ul>
                            <div class="tab-content">
                                <div class="tab-pane active show" id="tabs-basic">
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">节点名称</label>
                                                <input type="text" class="form-control" v-model="newNode.name">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label required">节点类型</label>
                                                <select class="form-select" :class="{ 'is-invalid': validationErrors.type }" v-model="newNode.type">
                                                    <option v-for="type in nodeTypes" :key="type.value" :value="type.value">{{ type.label }}</option>
                                                </select>
                                                <div class="invalid-feedback" v-if="validationErrors.type">{{ validationErrors.type }}</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label required">服务器</label>
                                                <select class="form-select" :class="{ 'is-invalid': validationErrors.serverId }" v-model="newNode.serverId" @change="onServerChange">
                                                    <option v-for="server in servers" :key="server.id" :value="server.id">{{ server.name }}</option>
                                                </select>
                                                <div class="invalid-feedback" v-if="validationErrors.serverId">{{ validationErrors.serverId }}</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label required">端口</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" :class="{ 'is-invalid': validationErrors.port }" v-model="newNode.port" min="1" max="65535">
                                                    <button class="btn" type="button" @click="getAvailablePort">自动获取</button>
                                                </div>
                                                <div class="invalid-feedback" v-if="validationErrors.port">{{ validationErrors.port }}</div>
                                                <small class="form-hint" v-if="portCheckMessage">{{ portCheckMessage }}</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">级别</label>
                                                <input type="number" class="form-control" v-model="newNode.level" min="0">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">备注</label>
                                        <textarea class="form-control" v-model="newNode.remark" rows="2"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" v-model="newNode.disabled">
                                            <span class="form-check-label">禁用节点</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="tab-pane" id="tabs-inbound">
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label required">协议</label>
                                                <select class="form-select" :class="{ 'is-invalid': validationErrors.protocol }" v-model="newNodeInbound.protocol" @change="onProtocolChange">
                                                    <option v-for="protocol in protocolTypes" :key="protocol.value" :value="protocol.value">{{ protocol.label }}</option>
                                                </select>
                                                <div class="invalid-feedback" v-if="validationErrors.protocol">{{ validationErrors.protocol }}</div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 根据不同的协议类型显示不同的参数表单 -->
                                    <div v-if="newNodeInbound.protocol === 'VLESS'">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">加密方式</label>
                                                    <select class="form-select" v-model="newNodeInbound.encryption">
                                                        <option value="none">none</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">UUID</label>
                                                    <div class="input-group">
                                                        <input type="text" class="form-control" v-model="newNodeInbound.uuid">
                                                        <button class="btn" type="button" @click="generateUuid">生成</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div v-else-if="newNodeInbound.protocol === 'Shadowsocks'">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">加密方式</label>
                                                    <select class="form-select" v-model="newNodeInbound.method">
                                                        <option value="aes-256-gcm">aes-256-gcm</option>
                                                        <option value="chacha20-poly1305">chacha20-poly1305</option>
                                                        <option value="2022-blake3-aes-256-gcm">2022-blake3-aes-256-gcm</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">密码</label>
                                                    <div class="input-group">
                                                        <input type="text" class="form-control" v-model="newNodeInbound.password">
                                                        <button class="btn" type="button" @click="generateRandomPassword">生成</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div v-else-if="newNodeInbound.protocol === 'Socks'">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">用户名</label>
                                                    <input type="text" class="form-control" v-model="newNodeInbound.username">
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">密码</label>
                                                    <div class="input-group">
                                                        <input type="text" class="form-control" v-model="newNodeInbound.password">
                                                        <button class="btn" type="button" @click="generateRandomPassword">生成</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div v-else-if="newNodeInbound.protocol === 'Hysteria2'">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">密码</label>
                                                    <div class="input-group">
                                                        <input type="text" class="form-control" v-model="newNodeInbound.password">
                                                        <button class="btn" type="button" @click="generateRandomPassword">生成</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">上行带宽 (Mbps)</label>
                                                    <input type="number" class="form-control" v-model="newNodeInbound.up_mbps" min="1">
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">下行带宽 (Mbps)</label>
                                                    <input type="number" class="form-control" v-model="newNodeInbound.down_mbps" min="1">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div v-else-if="newNodeInbound.protocol === 'ShadowTLS'">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">版本</label>
                                                    <select class="form-select" v-model="newNodeInbound.version">
                                                        <option :value="1">1</option>
                                                        <option :value="2">2</option>
                                                        <option :value="3">3</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">密码</label>
                                                    <div class="input-group">
                                                        <input type="text" class="form-control" v-model="newNodeInbound.password">
                                                        <button class="btn" type="button" @click="generateRandomPassword">生成</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-12">
                                            <div class="mb-3">
                                                <label class="form-label">高级配置 (JSON)</label>
                                                <textarea class="form-control font-monospace" v-model="newNodeInboundJson" rows="5" placeholder='{"key": "value"}'></textarea>
                                                <small class="form-hint">可以添加协议特有的其他配置参数</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane" id="tabs-outbound">
                                    <div class="row mt-3">
                                        <div class="col-md-12">
                                            <div class="mb-3">
                                                <label class="form-label">出站配置 (JSON)</label>
                                                <textarea class="form-control font-monospace" v-model="newNodeOutboundJson" rows="10" placeholder='{"key": "value"}'></textarea>
                                                <small class="form-hint">用于配置节点的出站连接</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane" id="tabs-rule">
                                    <div class="row mt-3">
                                        <div class="col-md-12">
                                            <div class="mb-3">
                                                <label class="form-label">规则配置 (JSON)</label>
                                                <textarea class="form-control font-monospace" v-model="newNodeRuleJson" rows="10" placeholder='{"key": "value"}'></textarea>
                                                <small class="form-hint">用于配置节点的路由规则</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-link link-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="button" class="btn btn-primary" @click="createNode">创建</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit Node Modal -->
            <div class="modal modal-blur fade" id="editNodeModal" tabindex="-1" role="dialog">
                <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">编辑节点</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <ul class="nav nav-tabs" data-bs-toggle="tabs">
                                <li class="nav-item">
                                    <a href="#edit-tabs-basic" class="nav-link active" data-bs-toggle="tab">基本信息</a>
                                </li>
                                <li class="nav-item">
                                    <a href="#edit-tabs-inbound" class="nav-link" data-bs-toggle="tab">入站配置</a>
                                </li>
                                <li class="nav-item">
                                    <a href="#edit-tabs-outbound" class="nav-link" data-bs-toggle="tab">出站配置</a>
                                </li>
                                <li class="nav-item">
                                    <a href="#edit-tabs-rule" class="nav-link" data-bs-toggle="tab">规则配置</a>
                                </li>
                            </ul>
                            <div class="tab-content">
                                <div class="tab-pane active show" id="edit-tabs-basic">
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">节点名称</label>
                                                <input type="text" class="form-control" v-model="editedNode.name">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label required">节点类型</label>
                                                <select class="form-select" :class="{ 'is-invalid': validationErrors.type }" v-model="editedNode.type">
                                                    <option v-for="type in nodeTypes" :key="type.value" :value="type.value">{{ type.label }}</option>
                                                </select>
                                                <div class="invalid-feedback" v-if="validationErrors.type">{{ validationErrors.type }}</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label required">服务器</label>
                                                <select class="form-select" :class="{ 'is-invalid': validationErrors.serverId }" v-model="editedNode.serverId" @change="onEditServerChange">
                                                    <option v-for="server in servers" :key="server.id" :value="server.id">{{ server.name }}</option>
                                                </select>
                                                <div class="invalid-feedback" v-if="validationErrors.serverId">{{ validationErrors.serverId }}</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label required">端口</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" :class="{ 'is-invalid': validationErrors.port }" v-model="editedNode.port" min="1" max="65535">
                                                    <button class="btn" type="button" @click="getEditAvailablePort">自动获取</button>
                                                </div>
                                                <div class="invalid-feedback" v-if="validationErrors.port">{{ validationErrors.port }}</div>
                                                <small class="form-hint" v-if="editPortCheckMessage">{{ editPortCheckMessage }}</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">级别</label>
                                                <input type="number" class="form-control" v-model="editedNode.level" min="0">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">备注</label>
                                        <textarea class="form-control" v-model="editedNode.remark" rows="2"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" :checked="editedNode.disabled === 1" @change="editedNode.disabled = $event.target.checked ? 1 : 0">
                                            <span class="form-check-label">禁用节点</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="tab-pane" id="edit-tabs-inbound">
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label required">协议</label>
                                                <select class="form-select" :class="{ 'is-invalid': validationErrors.protocol }" v-model="editedNodeInbound.protocol" @change="onEditProtocolChange">
                                                    <option v-for="protocol in protocolTypes" :key="protocol.value" :value="protocol.value">{{ protocol.label }}</option>
                                                </select>
                                                <div class="invalid-feedback" v-if="validationErrors.protocol">{{ validationErrors.protocol }}</div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 根据不同的协议类型显示不同的参数表单 -->
                                    <div v-if="editedNodeInbound.protocol === 'VLESS'">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">加密方式</label>
                                                    <select class="form-select" v-model="editedNodeInbound.encryption">
                                                        <option value="none">none</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">UUID</label>
                                                    <div class="input-group">
                                                        <input type="text" class="form-control" v-model="editedNodeInbound.uuid">
                                                        <button class="btn" type="button" @click="generateEditUuid">生成</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 其他协议配置项与创建模态框类似，省略重复代码 -->

                                    <div class="row mt-3">
                                        <div class="col-md-12">
                                            <div class="mb-3">
                                                <label class="form-label">高级配置 (JSON)</label>
                                                <textarea class="form-control font-monospace" v-model="editedNodeInboundJson" rows="5" placeholder='{"key": "value"}'></textarea>
                                                <small class="form-hint">可以添加协议特有的其他配置参数</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane" id="edit-tabs-outbound">
                                    <div class="row mt-3">
                                        <div class="col-md-12">
                                            <div class="mb-3">
                                                <label class="form-label">出站配置 (JSON)</label>
                                                <textarea class="form-control font-monospace" v-model="editedNodeOutboundJson" rows="10" placeholder='{"key": "value"}'></textarea>
                                                <small class="form-hint">用于配置节点的出站连接</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane" id="edit-tabs-rule">
                                    <div class="row mt-3">
                                        <div class="col-md-12">
                                            <div class="mb-3">
                                                <label class="form-label">规则配置 (JSON)</label>
                                                <textarea class="form-control font-monospace" v-model="editedNodeRuleJson" rows="10" placeholder='{"key": "value"}'></textarea>
                                                <small class="form-hint">用于配置节点的路由规则</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-link link-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="button" class="btn btn-primary" @click="updateNode">保存</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View Config Modal -->
            <div class="modal modal-blur fade" id="viewConfigModal" tabindex="-1" role="dialog">
                <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">节点配置</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <ul class="nav nav-tabs" data-bs-toggle="tabs">
                                <li class="nav-item">
                                    <a href="#view-tabs-inbound" class="nav-link active" data-bs-toggle="tab">入站配置</a>
                                </li>
                                <li class="nav-item">
                                    <a href="#view-tabs-outbound" class="nav-link" data-bs-toggle="tab">出站配置</a>
                                </li>
                                <li class="nav-item">
                                    <a href="#view-tabs-rule" class="nav-link" data-bs-toggle="tab">规则配置</a>
                                </li>
                            </ul>
                            <div class="tab-content">
                                <div class="tab-pane active show" id="view-tabs-inbound">
                                    <div class="row mt-3">
                                        <div class="col-md-12">
                                            <pre class="bg-light p-3 rounded">{{ selectedNodeInboundFormatted }}</pre>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane" id="view-tabs-outbound">
                                    <div class="row mt-3">
                                        <div class="col-md-12">
                                            <pre class="bg-light p-3 rounded">{{ selectedNodeOutboundFormatted }}</pre>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane" id="view-tabs-rule">
                                    <div class="row mt-3">
                                        <div class="col-md-12">
                                            <pre class="bg-light p-3 rounded">{{ selectedNodeRuleFormatted }}</pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-link link-secondary" data-bs-dismiss="modal">关闭</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:fragment="script" th:inline="javascript">
    PetiteVue.createApp({
        // Data
        nodes: [],
        servers: [],
        nodeTypes: [],
        protocolTypes: [],
        searchQuery: '',
        filterServerId: '',
        filterType: '',
        filterStatus: '',
        currentPage: 1,
        pageSize: 10,
        totalItems: 0,
        totalPages: 0,
        stats: {
            total: 0,
            proxy: 0,
            landing: 0,
            active: 0,
            disabled: 0
        },
        selectedNode: null,
        deleteModal: null,
        createModal: null,
        editModal: null,
        viewConfigModal: null,
        loading: true,
        searchTimeout: null,
        portCheckMessage: '',
        editPortCheckMessage: '',
        newNode: {
            serverId: '',
            port: null,
            type: 0, // 默认为代理节点
            level: 0,
            disabled: false,
            name: '',
            remark: '',
            inbound: null,
            outbound: null,
            rule: null
        },
        newNodeInbound: {
            protocol: 'VLESS'
        },
        newNodeInboundJson: '',
        newNodeOutboundJson: '',
        newNodeRuleJson: '',
        editedNode: {
            id: null,
            serverId: '',
            port: null,
            type: 0,
            level: 0,
            disabled: 0,
            name: '',
            remark: '',
            inbound: null,
            outbound: null,
            rule: null
        },
        editedNodeInbound: {
            protocol: 'VLESS'
        },
        editedNodeInboundJson: '',
        editedNodeOutboundJson: '',
        editedNodeRuleJson: '',
        validationErrors: {},

        // Lifecycle hooks
        mounted() {
            this.fetchServers();
            this.fetchNodeTypes();
            this.fetchProtocolTypes();
            this.fetchNodes();
        },

        // Computed properties
        get startIndex() {
            return (this.currentPage - 1) * this.pageSize + 1;
        },

        get endIndex() {
            return Math.min(this.startIndex + this.pageSize - 1, this.totalItems);
        },

        get paginationPages() {
            // Show at most 5 page numbers
            const maxPages = 5;
            const pages = [];
            let startPage = Math.max(1, this.currentPage - Math.floor(maxPages / 2));
            let endPage = Math.min(this.totalPages, startPage + maxPages - 1);

            if (endPage - startPage + 1 < maxPages) {
                startPage = Math.max(1, endPage - maxPages + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                pages.push(i);
            }

            return pages;
        },

        get selectedNodeInboundFormatted() {
            if (!this.selectedNode || !this.selectedNode.inbound) {
                return "{}";
            }

            try {
                return JSON.stringify(this.selectedNode.inbound, null, 2);
            } catch (e) {
                return "{}";
            }
        },

        get selectedNodeOutboundFormatted() {
            if (!this.selectedNode || !this.selectedNode.outbound) {
                return "{}";
            }

            try {
                return JSON.stringify(this.selectedNode.outbound, null, 2);
            } catch (e) {
                return "{}";
            }
        },

        get selectedNodeRuleFormatted() {
            if (!this.selectedNode || !this.selectedNode.rule) {
                return "{}";
            }

            try {
                return JSON.stringify(this.selectedNode.rule, null, 2);
            } catch (e) {
                return "{}";
            }
        },

        // Methods
        fetchNodes() {
            this.loading = true;

            // Build query parameters
            const params = new URLSearchParams({
                page: this.currentPage,
                size: this.pageSize
            });

            if (this.searchQuery) {
                params.append('search', this.searchQuery);
            }

            if (this.filterServerId) {
                params.append('serverId', this.filterServerId);
            }

            if (this.filterType !== '') {
                params.append('type', this.filterType);
            }

            if (this.filterStatus === 'active') {
                params.append('disabled', false);
            } else if (this.filterStatus === 'disabled') {
                params.append('disabled', true);
            }

            fetch(`/api/admin/nodes?${params.toString()}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    this.nodes = data.records;
                    this.totalItems = data.total;
                    this.totalPages = data.pages;
                    this.currentPage = data.current;

                    // 统计数据
                    if (data.stats) {
                        this.stats = data.stats;
                    }

                    this.loading = false;
                })
                .catch(error => {
                    console.error('Error fetching nodes:', error);
                    ToastUtils.show('Error', 'Failed to load nodes.', 'danger');
                    this.loading = false;
                });
        },

        fetchServers() {
            fetch('/api/admin/nodes/servers')
                .then(response => response.json())
                .then(data => {
                    this.servers = data;

                    // 如果是第一次加载且当前没有选中服务器，选择第一个服务器
                    if (this.servers.length > 0 && !this.newNode.serverId) {
                        this.newNode.serverId = this.servers[0].id;
                    }
                })
                .catch(error => {
                    console.error('Error fetching servers:', error);
                });
        },

        fetchNodeTypes() {
            fetch('/api/admin/nodes/types')
                .then(response => response.json())
                .then(data => {
                    this.nodeTypes = data;
                })
                .catch(error => {
                    console.error('Error fetching node types:', error);
                });
        },

        fetchProtocolTypes() {
            fetch('/api/admin/nodes/protocols')
                .then(response => response.json())
                .then(data => {
                    this.protocolTypes = data;
                })
                .catch(error => {
                    console.error('Error fetching protocol types:', error);
                });
        },

        searchDebounced() {
            // Clear existing timeout
            if (this.searchTimeout) {
                clearTimeout(this.searchTimeout);
            }

            // Set new timeout to delay the API call
            this.searchTimeout = setTimeout(() => {
                this.currentPage = 1; // Reset to first page when searching
                this.fetchNodes();
            }, 500); // Wait for 500ms after user stops typing
        },

        getTypeBadgeClass(type) {
            switch (type) {
                case 0: return 'text-bg-blue';
                case 1: return 'text-bg-purple';
                default: return 'text-bg-secondary';
            }
        },

        getStatusBadgeClass(disabled) {
            return disabled === 0 ? 'text-bg-success' : 'text-bg-danger';
        },

        prevPage() {
            if (this.currentPage > 1) {
                this.currentPage--;
                this.fetchNodes();
            }
        },

        nextPage() {
            if (this.currentPage < this.totalPages) {
                this.currentPage++;
                this.fetchNodes();
            }
        },

        goToPage(page) {
            this.currentPage = page;
            this.fetchNodes();
        },

        changePageSize() {
            this.currentPage = 1; // Reset to first page when changing page size
            this.fetchNodes();
        },

        confirmDelete(node) {
            this.selectedNode = node;
            this.deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            this.deleteModal.show();
        },

        deleteNode() {
            if (!this.selectedNode) return;

            fetch(`/api/admin/nodes/${this.selectedNode.id}`, {
                method: 'DELETE'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('删除失败');
                    }

                    // Refetch the nodes data to update the list and pagination
                    this.fetchNodes();
                    ToastUtils.show('Success', '删除成功', 'success');

                    // Hide modal
                    this.deleteModal.hide();
                })
                .catch(error => {
                    console.error('Error:', error);
                    ToastUtils.show('Error', '删除失败', 'danger');
                });
        },

        // 查看节点配置
        viewNodeConfig(node) {
            this.selectedNode = node;
            this.viewConfigModal = new bootstrap.Modal(document.getElementById('viewConfigModal'));
            this.viewConfigModal.show();
        },

        // 服务器和端口相关方法
        onServerChange() {
            this.checkPortAvailability();
        },

        onEditServerChange() {
            this.checkEditPortAvailability();
        },

        checkPortAvailability() {
            if (!this.newNode.serverId || !this.newNode.port) {
                this.portCheckMessage = '';
                return;
            }

            fetch(`/api/admin/nodes/check-port?serverId=${this.newNode.serverId}&port=${this.newNode.port}`)
                .then(response => response.json())
                .then(data => {
                    if (data.available) {
                        this.portCheckMessage = '端口可用';
                    } else {
                        this.portCheckMessage = '端口已被占用';
                    }
                })
                .catch(error => {
                    console.error('Error checking port:', error);
                    this.portCheckMessage = '检查端口失败';
                });
        },

        checkEditPortAvailability() {
            if (!this.editedNode.serverId || !this.editedNode.port || !this.editedNode.id) {
                this.editPortCheckMessage = '';
                return;
            }

            fetch(`/api/admin/nodes/check-port?serverId=${this.editedNode.serverId}&port=${this.editedNode.port}&nodeId=${this.editedNode.id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.available) {
                        this.editPortCheckMessage = '端口可用';
                    } else {
                        this.editPortCheckMessage = '端口已被占用';
                    }
                })
                .catch(error => {
                    console.error('Error checking port:', error);
                    this.editPortCheckMessage = '检查端口失败';
                });
        },

        getAvailablePort() {
            if (!this.newNode.serverId) {
                ToastUtils.show('Warning', '请先选择服务器', 'warning');
                return;
            }

            fetch(`/api/admin/nodes/available-port?serverId=${this.newNode.serverId}`)
                .then(response => response.json())
                .then(data => {
                    this.newNode.port = data.port;
                    this.checkPortAvailability();
                })
                .catch(error => {
                    console.error('Error getting available port:', error);
                    ToastUtils.show('Error', '获取可用端口失败', 'danger');
                });
        },

        getEditAvailablePort() {
            if (!this.editedNode.serverId) {
                ToastUtils.show('Warning', '请先选择服务器', 'warning');
                return;
            }

            fetch(`/api/admin/nodes/available-port?serverId=${this.editedNode.serverId}`)
                .then(response => response.json())
                .then(data => {
                    this.editedNode.port = data.port;
                    this.checkEditPortAvailability();
                })
                .catch(error => {
                    console.error('Error getting available port:', error);
                    ToastUtils.show('Error', '获取可用端口失败', 'danger');
                });
        },

        // 协议相关方法
        onProtocolChange() {
            // 获取默认配置
            fetch(`/api/admin/nodes/default-inbound?protocol=${this.newNodeInbound.protocol}`)
                .then(response => response.json())
                .then(data => {
                    this.newNodeInbound = data;
                    this.newNodeInboundJson = JSON.stringify(data, null, 2);
                })
                .catch(error => {
                    console.error('Error getting default inbound config:', error);
                });
        },

        onEditProtocolChange() {
            // 获取默认配置
            fetch(`/api/admin/nodes/default-inbound?protocol=${this.editedNodeInbound.protocol}`)
                .then(response => response.json())
                .then(data => {
                    this.editedNodeInbound = data;
                    this.editedNodeInboundJson = JSON.stringify(data, null, 2);
                })
                .catch(error => {
                    console.error('Error getting default inbound config:', error);
                });
        },

        // 生成UUID
        generateUuid() {
            this.newNodeInbound.uuid = this.uuidv4();
        },

        generateEditUuid() {
            this.editedNodeInbound.uuid = this.uuidv4();
        },

        uuidv4() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        },

        // 生成随机密码
        generateRandomPassword() {
            const length = 16;
            const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
            let password = "";
            for (let i = 0; i < length; i++) {
                password += charset.charAt(Math.floor(Math.random() * charset.length));
            }

            if (this.newNodeInbound.password !== undefined) {
                this.newNodeInbound.password = password;
            }

            if (this.editedNodeInbound.password !== undefined) {
                this.editedNodeInbound.password = password;
            }
        },

        // Create Node methods
        openCreateNodeModal() {
            // Reset form
            this.newNode = {
                serverId: this.servers.length > 0 ? this.servers[0].id : '',
                port: null,
                type: 0, // 默认为代理节点
                level: 0,
                disabled: false,
                name: '',
                remark: '',
                inbound: null,
                outbound: null,
                rule: null
            };

            // 获取默认入站配置
            this.newNodeInbound = {
                protocol: 'VLESS'
            };
            this.onProtocolChange(); // 获取默认配置

            this.newNodeOutboundJson = '{}';
            this.newNodeRuleJson = '{}';
            this.portCheckMessage = '';
            this.validationErrors = {};

            // Show modal
            this.createModal = new bootstrap.Modal(document.getElementById('createNodeModal'));
            this.createModal.show();
        },

        validateNodeForm(node) {
            let isValid = true;
            this.validationErrors = {};

            // Check server
            if (!node.serverId) {
                this.validationErrors.serverId = '请选择服务器';
                isValid = false;
            }

            // Check port
            if (!node.port) {
                this.validationErrors.port = '请输入端口';
                isValid = false;
            } else if (node.port < 1 || node.port > 65535) {
                this.validationErrors.port = '端口范围应为1-65535';
                isValid = false;
            }

            // Check node type
            if (node.type === null || node.type === undefined) {
                this.validationErrors.type = '请选择节点类型';
                isValid = false;
            }

            return isValid;
        },

        createNode() {
            // 验证表单
            if (!this.validateNodeForm(this.newNode)) {
                return;
            }

            // 合并JSON到inbound
            try {
                let inboundConfig = this.newNodeInbound;
                if (this.newNodeInboundJson) {
                    const jsonData = JSON.parse(this.newNodeInboundJson);
                    inboundConfig = { ...inboundConfig, ...jsonData };
                }

                // 处理出站和规则配置
                let outboundConfig = null;
                let ruleConfig = null;

                if (this.newNodeOutboundJson && this.newNodeOutboundJson.trim() !== '{}') {
                    outboundConfig = JSON.parse(this.newNodeOutboundJson);
                }

                if (this.newNodeRuleJson && this.newNodeRuleJson.trim() !== '{}') {
                    ruleConfig = JSON.parse(this.newNodeRuleJson);
                }

                // 准备发送的数据
                const nodeData = {
                    serverId: this.newNode.serverId,
                    port: this.newNode.port,
                    type: this.newNode.type,
                    level: this.newNode.level || 0,
                    disabled: this.newNode.disabled ? 1 : 0,
                    name: this.newNode.name || null,
                    remark: this.newNode.remark || null,
                    inbound: inboundConfig,
                    outbound: outboundConfig,
                    rule: ruleConfig
                };

                fetch('/api/admin/nodes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(nodeData)
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(data => {
                                throw new Error(data.message || 'Validation error');
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        this.fetchNodes(); // Refresh the node list
                        this.createModal.hide();
                        ToastUtils.show('Success', '创建成功', 'success');
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        ToastUtils.show('Error', error.message || '创建失败', 'danger');
                    });
            } catch (e) {
                console.error('Error parsing JSON:', e);
                ToastUtils.show('Error', 'JSON格式错误: ' + e.message, 'danger');
            }
        },

        // Edit Node methods
        openEditNodeModal(node) {
            // Clone node data to avoid direct mutation
            this.editedNode = {
                id: node.id,
                serverId: node.serverId,
                port: node.port,
                type: node.type,
                level: node.level || 0,
                disabled: node.disabled,
                name: node.name || '',
                remark: node.remark || '',
                inbound: node.inbound,
                outbound: node.outbound,
                rule: node.rule
            };

            // 处理inbound配置
            this.editedNodeInbound = node.inbound || { protocol: 'VLESS' };
            this.editedNodeInboundJson = JSON.stringify(node.inbound || {}, null, 2);

            // 处理outbound配置
            this.editedNodeOutboundJson = JSON.stringify(node.outbound || {}, null, 2);

            // 处理rule配置
            this.editedNodeRuleJson = JSON.stringify(node.rule || {}, null, 2);

            this.editPortCheckMessage = '';
            this.validationErrors = {};

            // Show modal
            this.editModal = new bootstrap.Modal(document.getElementById('editNodeModal'));
            this.editModal.show();
        },

        updateNode() {
            // 验证表单
            if (!this.validateNodeForm(this.editedNode)) {
                return;
            }

            // 合并JSON到inbound
            try {
                let inboundConfig = this.editedNodeInbound;
                if (this.editedNodeInboundJson) {
                    const jsonData = JSON.parse(this.editedNodeInboundJson);
                    inboundConfig = { ...inboundConfig, ...jsonData };
                }

                // 处理出站和规则配置
                let outboundConfig = null;
                let ruleConfig = null;

                if (this.editedNodeOutboundJson && this.editedNodeOutboundJson.trim() !== '{}') {
                    outboundConfig = JSON.parse(this.editedNodeOutboundJson);
                }

                if (this.editedNodeRuleJson && this.editedNodeRuleJson.trim() !== '{}') {
                    ruleConfig = JSON.parse(this.editedNodeRuleJson);
                }

                // 准备发送的数据
                const nodeData = {
                    id: this.editedNode.id,
                    serverId: this.editedNode.serverId,
                    port: this.editedNode.port,
                    type: this.editedNode.type,
                    level: this.editedNode.level || 0,
                    disabled: this.editedNode.disabled,
                    name: this.editedNode.name || null,
                    remark: this.editedNode.remark || null,
                    inbound: inboundConfig,
                    outbound: outboundConfig,
                    rule: ruleConfig
                };

                fetch(`/api/admin/nodes/${this.editedNode.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(nodeData)
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(data => {
                                throw new Error(data.message || 'Validation error');
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        this.fetchNodes(); // Refresh the node list
                        this.editModal.hide();
                        ToastUtils.show('Success', '更新成功', 'success');
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        ToastUtils.show('Error', error.message || '更新失败', 'danger');
                    });
            } catch (e) {
                console.error('Error parsing JSON:', e);
                ToastUtils.show('Error', 'JSON格式错误: ' + e.message, 'danger');
            }
        },

        // Toggle node status methods
        toggleNodeStatus(node, disabled) {
            const action = disabled ? 'disable' : 'enable';

            fetch(`/api/admin/nodes/${node.id}/${action}`, {
                method: 'PATCH'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('更新状态失败');
                    }
                    return response.json();
                })
                .then(data => {
                    // Update node status in the local array
                    const index = this.nodes.findIndex(n => n.id === node.id);
                    if (index !== -1) {
                        this.nodes[index].disabled = data.disabled;
                        this.nodes[index].statusDescription = data.disabled === 1 ? '已禁用' : '已启用';
                    }

                    ToastUtils.show('Success', '更新状态成功', 'success');
                })
                .catch(error => {
                    console.error('Error:', error);
                    ToastUtils.show('Error', '更新状态发生错误', 'danger');
                });
        }
    }).mount('#nodes-app');
</script>