<div th:fragment="content" class="page-body">
    <div class="container-xl">
        <div class="card" id="users-app" v-scope>
            <div class="card-header">
                <h3 class="card-title">Users</h3>
                <div class="card-actions">
                    <div class="row g-2">
                        <div class="col">
                            <input type="text" class="form-control" placeholder="搜索..." v-model="searchQuery" @input="searchDebounced">
                        </div>
                        <div class="col-auto">
                            <select class="form-select" v-model="filterRole" @change="fetchUsers">
                                <option value="">全部角色</option>
                                <option value="ADMIN">ADMIN</option>
                                <option value="PARTNER">PARTNER</option>
                                <option value="VIP">VIP</option>
                            </select>
                        </div>
                        <div class="col-auto">
                            <select class="form-select" v-model="filterStatus" @change="fetchUsers">
                                <option value="">全部状态</option>
                                <option value="active">Active</option>
                                <option value="disabled">Disabled</option>
                            </select>
                        </div>
                        <div class="col-auto">
                            <a th:href="@{/users/create}" class="btn btn-primary">
                                <i class="ti ti-plus"></i> 添加用户
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-vcenter card-table">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Email</th>
                            <th>Nickname</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr v-for="user in users" :key="user.id">
                            <td v-text="user.id"></td>
                            <td v-text="user.email"></td>
                            <td v-text="user.nickName || '-'"></td>
                            <td>
                                <span class="badge" :class="getRoleBadgeClass(user.role)" v-text="user.role || 'PARTNER'"></span>
                            </td>
                            <td>
                                <span class="badge" :class="getStatusBadgeClass(user.disabled)">
                                    {{ user.disabled === 0 ? 'Active' : 'Disabled' }}
                                </span>
                            </td>
                            <td v-text="formatDate(user.createTime)"></td>
                            <td>
                                <div class="btn-list flex-nowrap">
                                    <a :href="'/users/edit/' + user.id" class="btn btn-sm btn-outline-primary">
                                        <i class="ti ti-edit"></i> Edit
                                    </a>
                                    <button @click="toggleUserStatus(user)" class="btn btn-sm"
                                            :class="user.disabled === 0 ? 'btn-outline-danger' : 'btn-outline-success'">
                                        <i class="ti" :class="user.disabled === 0 ? 'ti-ban' : 'ti-check'"></i>
                                        {{ user.disabled === 0 ? 'Disable' : 'Enable' }}
                                    </button>
                                    <button @click="confirmDelete(user)" class="btn btn-sm btn-outline-danger">
                                        <i class="ti ti-trash"></i> Delete
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <tr v-if="loading">
                            <td colspan="7" class="text-center py-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </td>
                        </tr>
                        <tr v-else-if="users.length === 0">
                            <td colspan="7" class="text-center py-3">没有查到数据.</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- 分页 -->
            <div class="card-footer d-flex align-items-center">
                <div class="d-flex">
                    <div class="text-muted">
                        每页显示
                        <div class="mx-2 d-inline-block">
                            <select class="form-select form-select-sm" v-model="pageSize" @change="changePageSize">
                                <option value="5">5</option>
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                        条记录
                    </div>
                    <div class="ms-auto text-muted" v-if="totalItems > 0">
                        显示
                        <span class="text-body strong">{{ startIndex }}</span> 到
                        <span class="text-body strong">{{ endIndex }}</span> 条，共
                        <span class="text-body strong">{{ totalItems }}</span> 条
                    </div>
                </div>
                <ul class="pagination m-0 ms-auto" v-if="totalPages > 0">
                    <li class="page-item" :class="{ disabled: currentPage === 1 }">
                        <a class="page-link" href="#" @click.prevent="prevPage">
                            <i class="ti ti-chevron-left"></i> 上一页
                        </a>
                    </li>
                    <!-- Display page numbers dynamically -->
                    <li class="page-item" v-for="page in paginationPages" :key="page"
                        :class="{ active: page === currentPage }">
                        <a class="page-link" href="#" @click.prevent="goToPage(page)">{{ page }}</a>
                    </li>
                    <li class="page-item" :class="{ disabled: currentPage === totalPages }">
                        <a class="page-link" href="#" @click.prevent="nextPage">
                            下一页 <i class="ti ti-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Delete Confirmation Modal -->
            <div class="modal modal-blur fade" id="deleteModal" tabindex="-1" role="dialog" aria-hidden="true">
                <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-body">
                            <div class="modal-title">Are you sure?</div>
                            <div>If you proceed, you will lose all data for this user.</div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-link link-secondary me-auto" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-danger" @click="deleteUser">Yes, delete</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:fragment="script" th:inline="javascript">
    PetiteVue.createApp({
        // Data
        users: [],
        searchQuery: '',
        filterRole: '',
        filterStatus: '',
        currentPage: 1,
        pageSize: 10,
        totalItems: 0,
        totalPages: 0,
        selectedUser: null,
        deleteModal: null,
        loading: true,
        searchTimeout: null,

        // Lifecycle hooks
        mounted() {
            console.info(11111111111111111)
            this.fetchUsers();
        },

        // Computed properties
        get startIndex() {
            return (this.currentPage - 1) * this.pageSize + 1;
        },

        get endIndex() {
            return Math.min(this.startIndex + this.pageSize - 1, this.totalItems);
        },

        get paginationPages() {
            // Show at most 5 page numbers
            const maxPages = 5;
            const pages = [];
            let startPage = Math.max(1, this.currentPage - Math.floor(maxPages / 2));
            let endPage = Math.min(this.totalPages, startPage + maxPages - 1);

            if (endPage - startPage + 1 < maxPages) {
                startPage = Math.max(1, endPage - maxPages + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                pages.push(i);
            }

            return pages;
        },

        // Methods
        fetchUsers() {
            this.loading = true;

            // Build query parameters
            const params = new URLSearchParams({
                page: this.currentPage,
                size: this.pageSize
            });

            if (this.searchQuery) {
                params.append('search', this.searchQuery);
            }

            if (this.filterRole) {
                params.append('role', this.filterRole);
            }

            if (this.filterStatus) {
                params.append('status', this.filterStatus);
            }

            fetch(`/api/admin/users?${params.toString()}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    this.users = data.records;
                    this.totalItems = data.total;
                    this.totalPages = data.pages;
                    this.currentPage = data.current;
                    this.loading = false;
                })
                .catch(error => {
                    console.error('Error fetching users:', error);
                    this.showToast('Error', 'Failed to load users.', 'danger');
                    this.loading = false;
                });
        },

        searchDebounced() {
            // Clear existing timeout
            if (this.searchTimeout) {
                clearTimeout(this.searchTimeout);
            }

            // Set new timeout to delay the API call
            this.searchTimeout = setTimeout(() => {
                this.currentPage = 1; // Reset to first page when searching
                this.fetchUsers();
            }, 500); // Wait for 500ms after user stops typing
        },

        formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        },

        getRoleBadgeClass(role) {
            switch (role && role.toUpperCase()) {
                case 'ADMIN': return 'text-bg-purple';
                case 'PARTNER': return 'text-bg-indigo';
                default: return 'text-bg-blue'; // VIP or other roles
            }
        },

        getStatusBadgeClass(disabled) {
            return disabled === 0 ? 'text-bg-success' : 'text-bg-danger';
        },

        prevPage() {
            if (this.currentPage > 1) {
                this.currentPage--;
                this.fetchUsers();
            }
        },

        nextPage() {
            if (this.currentPage < this.totalPages) {
                this.currentPage++;
                this.fetchUsers();
            }
        },

        goToPage(page) {
            this.currentPage = page;
            this.fetchUsers();
        },

        changePageSize() {
            this.currentPage = 1; // Reset to first page when changing page size
            this.fetchUsers();
        },

        toggleUserStatus(user) {
            const action = user.disabled === 0 ? 'disable' : 'enable';

            fetch(`/api/users/${user.id}/${action}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').getAttribute('content')
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to update user status');
                    }
                    return response.json();
                })
                .then(data => {
                    // Update user status in the local array
                    const index = this.users.findIndex(u => u.id === user.id);
                    if (index !== -1) {
                        this.users[index].disabled = data.disabled;
                    }

                    this.showToast('Success', 'User status updated successfully.', 'success');
                })
                .catch(error => {
                    console.error('Error:', error);
                    this.showToast('Error', 'Failed to update user status.', 'danger');
                });
        },

        confirmDelete(user) {
            this.selectedUser = user;
            this.deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            this.deleteModal.show();
        },

        deleteUser() {
            if (!this.selectedUser) return;

            fetch(`/api/users/${this.selectedUser.id}`, {
                method: 'DELETE',
                headers: {
                    'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').getAttribute('content')
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to delete user');
                    }

                    // Refetch the users data to update the list and pagination
                    this.fetchUsers();
                    this.showToast('Success', 'User deleted successfully.', 'success');

                    // Hide modal
                    this.deleteModal.hide();
                })
                .catch(error => {
                    console.error('Error:', error);
                    this.showToast('Error', 'Failed to delete user.', 'danger');
                });
        },

        showToast(title, message, type) {
            const toast = document.createElement('div');
            toast.innerHTML = `
                <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="2000">
                  <div class="toast-header bg-${type} text-white">
                    <strong class="me-auto">${title}</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                  </div>
                  <div class="toast-body">
                    ${message}
                  </div>
                </div>
            `;
            document.body.appendChild(toast);

            // Auto-remove after 2 seconds
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 2000);
        }
    }).mount('#users-app');
</script>